---
// Import the Layout component
import BaseLayout from '../layouts/BaseLayout.astro';
import MarqueeSimple from '../components/MarqueeSimple.astro';
import ThemeAwareButton from '../components/ThemeAwareButton.astro';

// Import new components
import NavBar from '../components/navigation/NavBar.astro';
import HeroSection from '../components/sections/HeroSection.astro';
import ServicesSection from '../components/sections/ServicesSection.astro';
import ReviewsSection from '../components/sections/ReviewsSection.astro';
import DockMenu from '../components/navigation/DockMenu.astro';
import Section from '../components/layout/Section.astro';
import Container from '../components/layout/Container.astro';
import PageSection from '../components/layout/PageSection.astro';
import ProcessSlideshow from '../components/content/ProcessSlideshow.astro';
import CaseStudyContent from '../components/content/CaseStudyContent.astro';
import ChatBox from '../components/ui/ChatBox.astro';
---

<BaseLayout title="MannyKnows - AI-Powered E-commerce Solutions">
	<main class="relative bg-light-primary dark:bg-dark-primary text-text-light-primary dark:text-text-dark-primary min-h-screen transition-colors duration-300">
		<!-- Marquee Announcement Section -->
		<MarqueeSimple />

			<!-- Header Container with Subtle Background -->
			<header class="relative bg-gradient-to-t from-gray-50/50 via-gray-100/30 to-gray-50/20 dark:from-gray-900/60 dark:via-slate-800/40 dark:to-gray-900/30 transition-colors duration-300">

            <!-- Navigation -->
            <NavBar />

            <!-- Hero Section -->
            <HeroSection 
				title="Scale your" 
				highlightedText="business operations" 
				subtitle="Optimize your operations from end to end with intelligent AI. We automate critical tasks across your marketing, sales, and support workflows to boost productivity, cut costs, and drive scalable growth."
			/>
        </header>

		<!-- Services Section -->
		<ServicesSection />

		<!-- Process Section -->
		<PageSection 
			id="process" 
			title="Our Process" 
			subtitle="From discovery to deployment we follow a proven methodology to transform your e-commerce vision into reality"
			variant="alternate"
		>
			<!-- <ProcessSlideshow /> -->
		</PageSection>

		<!-- Case Study Section -->
		<PageSection 
			id="case-study" 
			title="Case Study" 
			subtitle="AI-Powered E-commerce Transformation Case Study"
			variant="alternate"
		>
			<CaseStudyContent />
		</PageSection>

		<!-- Customer Reviews Section -->
		<ReviewsSection />

		<!-- Floating Chat Box -->
		<ChatBox />

		<!-- Floating Dock Menu -->
		<DockMenu />
	</main>
</BaseLayout>

<script>
	// Declare global posthog variable for TypeScript
	declare global {
		interface Window {
			posthog?: any;
			MannyKnowsAnimations?: any;
		}
		var posthog: any;
	}
	
	// ========================================
	// DEVELOPER SETTINGS - Easy Toggle Controls
	// ========================================
	const ANIMATION_CONFIG = {
		// Search bar apple gradient animation
		searchGradientEnabled: true,
		
		// Background gradient rewind animation
		backgroundRewindEnabled: true,
		
		// Search animation timing
		searchScrollDelay: 0, // ms delay before removing gradient on scroll
		
		// Debug mode - logs animation state changes
		debugMode: false
	};

	// Optimized marquee implementation
	function initMarquee() {
		const marqueeContent = document.querySelector('.marquee-content');
		if (!marqueeContent) return;

		// Use CSS custom property for dynamic duration
		const contentWidth = marqueeContent.scrollWidth;
		const duration = Math.max(contentWidth / 50, 20); // Min 20s, max based on content
		
		document.documentElement.style.setProperty('--marquee-duration', `${duration}s`);
	}

	// Search input apple gradient animation
	function initSearchAnimation() {
		if (!ANIMATION_CONFIG.searchGradientEnabled) {
			if (ANIMATION_CONFIG.debugMode) console.log('Search gradient animation disabled');
			return;
		}

		const searchInput = document.getElementById('search-input');
		if (!searchInput) return;

		if (ANIMATION_CONFIG.debugMode) console.log('Search gradient animation enabled');

		// Add gradient on focus
		const addGradient = () => {
			searchInput.classList.add('apple-gradient-active');
			if (ANIMATION_CONFIG.debugMode) console.log('Search gradient activated');
		};

		// Remove gradient
		const removeGradient = () => {
			searchInput.classList.remove('apple-gradient-active');
			if (ANIMATION_CONFIG.debugMode) console.log('Search gradient deactivated');
		};

		// Event listeners
		searchInput.addEventListener('focus', addGradient);
		searchInput.addEventListener('blur', removeGradient);
		
		// Remove gradient on scroll (user is moving away)
		let scrollTimeout: ReturnType<typeof setTimeout> | undefined;
		const handleScroll = () => {
			if (searchInput.classList.contains('apple-gradient-active')) {
				clearTimeout(scrollTimeout);
				scrollTimeout = setTimeout(removeGradient, ANIMATION_CONFIG.searchScrollDelay);
			}
		};
		
		window.addEventListener('scroll', handleScroll, { passive: true });
	}

	// Navigation visibility tracking
	function initNavigationTracking() {
		const topNav = document.getElementById('topNav');
		const floatingDock = document.getElementById('floatingDock');
		
		if (!topNav || !floatingDock) return;

		const observer = new IntersectionObserver((entries) => {
			entries.forEach((entry) => {
				if (entry.isIntersecting) {
					// Top nav is visible, hide floating dock
					floatingDock.classList.add('translate-y-full', 'opacity-0');
				} else {
					// Top nav is not visible, show floating dock
					floatingDock.classList.remove('translate-y-full', 'opacity-0');
				}
			});
		}, {
			threshold: 0.1
		});

		observer.observe(topNav);
	}

	// Dock tooltips
	function initDockTooltips() {
		const dockItems = document.querySelectorAll('.dock-item[data-tooltip]');
		
		dockItems.forEach(item => {
			const tooltip = document.createElement('div');
			tooltip.className = 'absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-black dark:bg-white text-white dark:text-black text-sm whitespace-nowrap rounded opacity-0 invisible transition-all duration-200 z-50 shadow-lg';
			tooltip.textContent = item.getAttribute('data-tooltip');
			
			// Add arrow
			const arrow = document.createElement('div');
			arrow.className = 'absolute top-full left-1/2 transform -translate-x-1/2 border-l-4 border-r-4 border-t-4 border-transparent border-t-black dark:border-t-white';
			tooltip.appendChild(arrow);
			
			item.appendChild(tooltip);
			
			item.addEventListener('mouseenter', () => {
				tooltip.classList.remove('opacity-0', 'invisible');
				tooltip.classList.add('opacity-100', 'visible');
			});
			
			item.addEventListener('mouseleave', () => {
				tooltip.classList.add('opacity-0', 'invisible');
				tooltip.classList.remove('opacity-100', 'visible');
			});
		});
	}

	// Services section tracking
	function initServicesTracking() {
		// Track service card interactions
		const serviceCards = document.querySelectorAll('#services .group');
		serviceCards.forEach((card, index) => {
			const serviceName = card.querySelector('h3')?.textContent || `Service ${index + 1}`;
			
			card.addEventListener('mouseenter', () => {
				if (typeof posthog !== 'undefined') {
					posthog.capture('service_card_hover', {
						service_name: serviceName,
						service_position: index + 1
					});
				}
			});
			
			card.addEventListener('click', () => {
				if (typeof posthog !== 'undefined') {
					posthog.capture('service_card_click', {
						service_name: serviceName,
						service_position: index + 1
					});
				}
			});
		});

		// Track CTA button clicks
		const ctaButtons = document.querySelectorAll('#services a[href]');
		ctaButtons.forEach(button => {
			button.addEventListener('click', () => {
				if (typeof posthog !== 'undefined') {
					posthog.capture('services_cta_click', {
						button_text: button.textContent,
						button_href: button.getAttribute('href')
					});
				}
			});
		});
	}

	function initReviewsSection() {
		// Compact carousel functionality with looping
		const container = document.getElementById('reviewsContainer');
		const prevBtn = document.getElementById('prevReview');
		const nextBtn = document.getElementById('nextReview');
		
		if (!container || !prevBtn || !nextBtn) return;
		
		let currentIndex = 0;
		const totalCards = container.children.length;
		const cardsToShow = 3;
		
		function getCardWidth() {
			if (!container) return 0;
			const card = container.querySelector('.min-w-\\[calc\\(33\\.333\\%-1rem\\)\\]');
			return card ? (card as HTMLElement).offsetWidth + 32 : 0; // card width + margin
		}

		function updateCarousel() {
			if (!container) return;
			const cardWidth = getCardWidth();
			const translateX = -currentIndex * cardWidth;
			container.style.transform = `translateX(${translateX}px)`;
			
			// Always show buttons as enabled for looping
			if (prevBtn) prevBtn.style.opacity = '1';
			if (nextBtn) nextBtn.style.opacity = '1';
		}

		function nextSlide() {
			currentIndex = (currentIndex + 1) % totalCards;
			updateCarousel();
		}

		function prevSlide() {
			currentIndex = currentIndex === 0 ? totalCards - 1 : currentIndex - 1;
			updateCarousel();
		}

		// Event listeners
		nextBtn.addEventListener('click', nextSlide);
		prevBtn.addEventListener('click', prevSlide);

		// Initialize
		updateCarousel();

		// Handle resize
		window.addEventListener('resize', () => {
			updateCarousel(); // Recalculate on resize
		});

		// Intersection Observer for scroll animations
		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					// Animate cards
					(entry.target as HTMLElement).style.opacity = '1';
					(entry.target as HTMLElement).style.transform = 'translateY(0)';
				}
			});
		}, { threshold: 0.2 });

		// Track review interactions
		const allReviewCards = container.querySelectorAll('.min-w-\\[calc\\(33\\.333\\%-1rem\\)\\]');
		allReviewCards.forEach((card, index) => {
			// Set initial animation state
			(card as HTMLElement).style.opacity = '0';
			(card as HTMLElement).style.transform = 'translateY(30px)';
			(card as HTMLElement).style.transition = 'all 0.8s ease';
			observer.observe(card);
			
			// Track clicks
			card.addEventListener('click', () => {
				if (typeof posthog !== 'undefined') {
					const customerName = card.querySelector('.font-semibold')?.textContent || `Review ${index + 1}`;
					posthog.capture('review_card_click', {
						customer_name: customerName,
						review_position: index + 1
					});
				}
			});
		});

		// Track carousel interactions
		if (typeof posthog !== 'undefined') {
			nextBtn.addEventListener('click', () => {
				posthog.capture('reviews_carousel_next', {
					current_index: currentIndex,
					interaction_type: 'button_click'
				});
			});

			prevBtn.addEventListener('click', () => {
				posthog.capture('reviews_carousel_prev', {
					current_index: currentIndex,
					interaction_type: 'button_click'
				});
			});
		}
	}

	// Apply animation settings
	function applyAnimationSettings() {
		const body = document.body;
		
		// Apply search gradient setting
		if (!ANIMATION_CONFIG.searchGradientEnabled) {
			body.classList.add('search-gradient-disabled');
			if (ANIMATION_CONFIG.debugMode) console.log('Search gradient disabled via CSS class');
		} else {
			body.classList.remove('search-gradient-disabled');
		}
		
		// Apply background rewind setting via CSS injection
		if (!ANIMATION_CONFIG.backgroundRewindEnabled) {
			// Inject original looping animation
			const style = document.createElement('style');
			style.textContent = `
				@keyframes gradient-flow {
					0% { background-position: 0% 50%; }
					50% { background-position: 100% 50%; }
					100% { background-position: 0% 50%; }
				}
			`;
			document.head.appendChild(style);
			if (ANIMATION_CONFIG.debugMode) console.log('Background rewind disabled - using original loop');
		} else {
			if (ANIMATION_CONFIG.debugMode) console.log('Background rewind enabled');
		}
	}

	// Developer utility - accessible from browser console
	window.MannyKnowsAnimations = {
		config: ANIMATION_CONFIG,
		toggleSearchGradient: () => {
			ANIMATION_CONFIG.searchGradientEnabled = !ANIMATION_CONFIG.searchGradientEnabled;
			applyAnimationSettings();
			console.log(`Search gradient: ${ANIMATION_CONFIG.searchGradientEnabled ? 'enabled' : 'disabled'}`);
		},
		toggleBackgroundRewind: () => {
			ANIMATION_CONFIG.backgroundRewindEnabled = !ANIMATION_CONFIG.backgroundRewindEnabled;
			console.log(`Background rewind: ${ANIMATION_CONFIG.backgroundRewindEnabled ? 'enabled' : 'disabled'}`);
			console.log('Refresh page to see changes');
		},
		toggleDebugMode: () => {
			ANIMATION_CONFIG.debugMode = !ANIMATION_CONFIG.debugMode;
			console.log(`Debug mode: ${ANIMATION_CONFIG.debugMode ? 'enabled' : 'disabled'}`);
		},
		status: () => {
			console.table(ANIMATION_CONFIG);
		}
	};

	// Use passive event listeners for better performance
	document.addEventListener('DOMContentLoaded', () => {
		// Apply animation settings first
		applyAnimationSettings();
		
		// Initialize all components
		initMarquee();
		initSearchAnimation();
		initNavigationTracking();
		initDockTooltips();
		initServicesTracking();
		initReviewsSection();
	}, { passive: true });
	
	window.addEventListener('resize', initMarquee, { passive: true });
</script>

<style>
	/* Custom CSS for marquee animation and responsive behavior */
	@media (max-width: 768px) {
		.container {
			@apply px-4;
		}
		
		.section-title {
			@apply text-3xl;
		}
	}

	/* Pause marquee on hover */
	.marquee-container:hover .animate-marquee {
		animation-play-state: paused;
	}

	/* Custom text selection - theme aware */
	::selection {
		background: #10d1ff !important;
		color: white !important;
	}

	::-moz-selection {
		background: #10d1ff !important;
		color: white !important;
	}

	/* Override for all elements */
	*::selection {
		background: #10d1ff !important;
		color: white !important;
	}

	*::-moz-selection {
		background: #10d1ff !important;
		color: white !important;
	}

	/* Smooth gradient shift animation */
	.animate-gradient-shift {
		background-size: 200% 200%;
		animation: gradient-shift 4s ease-in-out infinite;
	}

	/* Button gradient animation */
	.animate-button-gradient {
		background-size: 300% 300%;
		animation: button-gradient 6s ease-in-out infinite;
	}

	/* Keyframe for gradient animation */
	@keyframes gradient-shift {
		0%, 100% { background-position: 0% 50%; }
		33% { background-position: 100% 50%; }
		66% { background-position: 200% 50%; }
	}

	/* Keyframe for button gradient animation */
	@keyframes button-gradient {
		0%, 100% { background-position: 0% 50%; }
		50% { background-position: 100% 50%; }
	}

	/* Light theme specific overrides */
	@media (prefers-color-scheme: light) {
		:root:not(.dark) {
			/* Light theme shadows and effects */
			--shadow-color: rgba(0, 0, 0, 0.1);
		}
	}

	/* Dark theme specific overrides */
	@media (prefers-color-scheme: dark) {
		:root.dark {
			/* Dark theme shadows and effects */
			--shadow-color: rgba(0, 0, 0, 0.3);
		}
	}

	/* Pixel Canvas Opacity Adjustments */
	/* Reduce opacity in light mode for subtlety */
	:root:not(.dark) pixel-canvas {
		opacity: 0.15 !important;
	}
	
	/* Keep normal opacity in dark mode */
	:root.dark pixel-canvas {
		opacity: 0.4 !important;
	}
	
	/* Make buttons more prominent - excluding instant-quote which is handled by JS */
	:root:not(.dark) #topPodcastButton pixel-canvas,
	:root:not(.dark) #topChatToggle pixel-canvas {
		opacity: 0.35 !important;
	}
	
	:root.dark #topPodcastButton pixel-canvas,
	:root.dark #topChatToggle pixel-canvas {
		opacity: 0.3 !important;
	}

	/* Hide dock chat pixels until hover */
	#dockChatToggle pixel-canvas {
		opacity: 0 !important;
		transition: opacity 0.3s ease;
	}

	#dockChatToggle:hover pixel-canvas {
		opacity: 0.25 !important; /* light mode */
	}

	:root.dark #dockChatToggle:hover pixel-canvas {
		opacity: 0.5 !important; /* dark mode */
	}
	
</style>
