---
export interface Props {
  className?: string;
}

const { className = '' } = Astro.props;
---

<!-- Floating Chat Box -->
<div id="chatBox" class={`fixed bottom-24 right-6 w-96 h-[500px] bg-gradient-to-br from-black/10 dark:from-white/10 via-black/5 dark:via-white/5 to-black/10 dark:to-white/10 border border-border-light dark:border-border-dark rounded-2xl backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.3)] dark:shadow-[0_20px_60px_rgba(0,0,0,0.3)] transform scale-0 transition-all duration-300 origin-bottom-right z-40 opacity-0 invisible ${className}`}>
  <div class="flex justify-between items-center p-1.75 border-b border-border-light dark:border-border-dark">
    <h3 class="text-text-light-primary dark:text-text-dark-primary m-0 text-lg font-semibold">ðŸ’¬ Talk to Us</h3>
    <button type="button" class="group bg-none border-none text-text-light-tertiary dark:text-text-dark-tertiary cursor-pointer p-1 rounded-md transition-all duration-300 flex items-center justify-center hover:bg-black/10 dark:hover:bg-white/10 hover:text-text-light-primary dark:hover:text-text-dark-primary" id="chatBoxClose">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  <div class="flex flex-col h-[calc(100%-64px)]">
    <div class="flex-1 p-1.75 overflow-y-auto flex flex-col gap-2.5" id="chatBoxMessages">
      <div class="flex gap-2.5 items-start">
        <div class="w-8 h-8 rounded-full bg-black/10 dark:bg-white/10 flex items-center justify-center text-base flex-shrink-0">ðŸ¤–</div>
        <div class="bg-black/20 dark:bg-white/20 py-2.25 px-4 rounded-xl text-text-light-primary dark:text-text-dark-primary leading-relaxed max-w-chat text-sm">
          Hi! I'm MannyKnows AI assistant. I can help you learn about our e-commerce solutions, get pricing for your online store, or answer questions about scaling your e-commerce business. What would you like to know?
        </div>
      </div>
    </div>
    <div class="flex gap-2 p-2.25 border-t border-border-light dark:border-border-dark">
      <label for="chatBoxInput" class="sr-only">Type your message</label>
      <input type="text" id="chatBoxInput" placeholder="Type your message..." class="flex-1 bg-black/20 dark:bg-white/20 border border-border-light dark:border-border-dark rounded-lg py-2 px-3 text-text-light-primary dark:text-text-dark-primary text-sm transition-all duration-300 placeholder:text-text-light-tertiary dark:placeholder:text-text-dark-tertiary focus:outline-none focus:border-primary-blue/50 focus:shadow-[0_0_0_2px_rgba(16,209,255,0.2)]">
      <button type="button" id="chatBoxSend" class="bg-gradient-to-r from-primary-blue to-sky-500 border-none rounded-lg text-white w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-105 hover:from-sky-500 hover:to-primary-blue" aria-label="Send message">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22,2 15,22 11,13 2,9"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // Chat Box functionality
  function initChatBox() {
    const chatBox = document.getElementById('chatBox');
    const topChatToggle = document.getElementById('topChatToggle');
    const dockChatToggle = document.getElementById('dockChatToggle');
    const heroChatButton = document.getElementById('heroChatButton');
    const chatBoxClose = document.getElementById('chatBoxClose');
    const chatBoxInput = document.getElementById('chatBoxInput') as HTMLInputElement;
    const chatBoxSend = document.getElementById('chatBoxSend');
    const chatBoxMessages = document.getElementById('chatBoxMessages');

    if (!chatBox) return;

    let isOpen = false;

    // Open chat box
    const openChatBox = () => {
      if (isOpen) return;
      isOpen = true;
      chatBox.classList.remove('scale-0', 'opacity-0', 'invisible');
      chatBox.classList.add('scale-100', 'opacity-100', 'visible');
      
      // Track chat open event
      // Analytics tracking removed for simplicity
      
      // Focus on input after chat opens
      setTimeout(() => chatBoxInput?.focus(), 300);
    };

    // Close chat box
    const closeChatBox = () => {
      if (!isOpen) return;
      isOpen = false;
      chatBox.classList.add('scale-0', 'opacity-0', 'invisible');
      chatBox.classList.remove('scale-100', 'opacity-100', 'visible');
    };

    // Event listeners
    topChatToggle?.addEventListener('click', openChatBox);
    dockChatToggle?.addEventListener('click', openChatBox);
    heroChatButton?.addEventListener('click', openChatBox);
    chatBoxClose?.addEventListener('click', closeChatBox);

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeChatBox();
      }
    });

    // Send message functionality
    const sendMessage = () => {
      const message = chatBoxInput?.value.trim();
      if (!message) return;

      // Track message sent event
      // Analytics tracking removed for simplicity

      // Add user message
      const userMessage = document.createElement('div');
      userMessage.className = 'flex gap-2.5 items-start flex-row-reverse text-right';
      userMessage.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-pink-500 text-white font-bold flex items-center justify-center flex-shrink-0 text-sm">U</div>
        <div class="bg-gradient-to-r from-blue-400 to-sky-500 text-white py-2.25 px-4 rounded-xl leading-relaxed max-w-chat text-sm">${message}</div>
      `;
      chatBoxMessages?.appendChild(userMessage);

      // Clear input
      if (chatBoxInput) chatBoxInput.value = '';

      // Scroll to bottom
      chatBoxMessages?.scrollTo({ top: chatBoxMessages.scrollHeight, behavior: 'smooth' });

      // Simulate bot response
      setTimeout(() => {
        const botResponse = document.createElement('div');
        botResponse.className = 'flex gap-2.5 items-start';
        botResponse.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-base flex-shrink-0">ðŸ¤–</div>
          <div class="bg-white/10 py-2.25 px-4 rounded-xl text-white leading-relaxed max-w-chat text-sm">Thanks for your message! I'm currently being set up to help you better. In the meantime, feel free to browse our services or contact us directly.</div>
        `;
        chatBoxMessages?.appendChild(botResponse);
        chatBoxMessages?.scrollTo({ top: chatBoxMessages.scrollHeight, behavior: 'smooth' });
      }, 1000);
    };

    // Send on button click
    chatBoxSend?.addEventListener('click', sendMessage);

    // Send on Enter key
    chatBoxInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', initChatBox);
</script>

<style>
  /* Chat box animations */
  #chatBox.scale-0 {
    transform: scale(0);
    transform-origin: bottom right;
  }

  #chatBox.scale-100 {
    transform: scale(1);
    transform-origin: bottom right;
  }

  /* Only keep the specific utility we actually use */
  .max-w-chat {
    max-width: 75%;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    #chatBox {
      @apply w-full max-w-sm right-4 left-4 mx-auto h-[450px];
    }
  }
</style>
