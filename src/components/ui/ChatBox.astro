---
export interface Props {
  className?: string;
}

const { className = '' } = Astro.props;
---

<!-- Chatting Hub -->
<div id="chatBox" class={`chat-hub-container transform scale-0 transition-all duration-300 origin-bottom-center z-40 opacity-0 invisible ${className} chat-glassmorphism`}>
  <div class="flex justify-between items-center p-4 border-b border-white/20 dark:border-white/10">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center">
        <span class="text-white font-bold text-lg">M</span>
      </div>
      <div>
        <h3 class="text-text-light-primary dark:text-text-dark-primary m-0 text-lg font-semibold">Chat with Manny</h3>
        <p class="text-text-light-secondary dark:text-text-dark-secondary m-0 text-sm">Your MK solutions architect</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button type="button" class="group bg-none border-none text-text-light-tertiary dark:text-text-dark-tertiary cursor-pointer p-2 rounded-md transition-all duration-300 flex items-center justify-center hover:bg-black/10 dark:hover:bg-white/10 hover:text-text-light-primary dark:hover:text-text-dark-primary" id="chatBoxClear" title="Clear conversation">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
        </svg>
      </button>
      <button type="button" class="group bg-none border-none text-text-light-tertiary dark:text-text-dark-tertiary cursor-pointer p-2 rounded-md transition-all duration-300 flex items-center justify-center hover:bg-black/10 dark:hover:bg-white/10 hover:text-text-light-primary dark:hover:text-text-dark-primary" id="chatBoxClose">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
  <div class="flex flex-col chat-body">
    <div class="flex-1 p-4 overflow-y-auto flex flex-col gap-3" id="chatBoxMessages">
      <div class="flex gap-3 items-start">
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">M</div>
        <div class="chat-message-bubble bot-message">
          Hey there! I'm Manny ðŸ¤“ what challenge can I help you solve today?
        </div>
      </div>
    </div>
    <div class="flex gap-3 p-4 border-t border-white/20 dark:border-white/10 chat-input-area">
      <label for="chatBoxInput" class="sr-only">Type your message</label>
      <input type="text" id="chatBoxInput" placeholder="Type your message..." class="flex-1 backdrop-blur-lg border rounded-lg py-3 px-4 text-text-light-primary dark:text-text-dark-primary text-sm transition-all duration-300 placeholder:text-text-light-tertiary dark:placeholder:text-text-dark-tertiary focus:outline-none chat-input">
      <button type="button" id="chatBoxSend" class="bg-gradient-to-r from-green-500 to-emerald-500 border-none rounded-lg text-white w-12 h-12 flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-105 hover:from-emerald-500 hover:to-green-500" aria-label="Send message">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22,2 15,22 11,13 2,9"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // Chat Box functionality with Manny AI integration
  function initChatBox() {
    const chatBox = document.getElementById('chatBox');
    const topChatToggle = document.getElementById('topChatToggle');
    const dockChatToggle = document.getElementById('dockChatToggle');
    const heroChatButton = document.getElementById('heroChatButton');
    const chatBoxClose = document.getElementById('chatBoxClose');
    const chatBoxInput = document.getElementById('chatBoxInput') as HTMLInputElement;
    const chatBoxSend = document.getElementById('chatBoxSend');
    const chatBoxMessages = document.getElementById('chatBoxMessages');

    if (!chatBox) return;

    let isOpen = false;
    
    // Session management for Manny AI (persist across refreshes)
    let sessionId = (typeof localStorage !== 'undefined' && localStorage.getItem('mk_chat_session_id')) || crypto.randomUUID();
    try {
      if (typeof localStorage !== 'undefined') {
        localStorage.setItem('mk_chat_session_id', sessionId);
      }
    } catch {}
    let conversationHistory: Array<{role: string, content: string}> = [];
    const MAX_MESSAGES = 20;

    // Input sanitization to prevent issues
    const sanitizeInput = (input: string): string => {
      return input
        .replace(/[<>]/g, '')
        .trim()
        .substring(0, 1000);
    };

    // Open chat box
    const openChatBox = () => {
      if (isOpen) return;
      isOpen = true;
      chatBox.classList.remove('scale-0', 'opacity-0', 'invisible');
      chatBox.classList.add('scale-100', 'opacity-100', 'visible');
      
      // Focus on input after chat opens
      setTimeout(() => chatBoxInput?.focus(), 300);
    };

    // Close chat box
    const closeChatBox = () => {
      if (!isOpen) return;
      isOpen = false;
      chatBox.classList.add('scale-0', 'opacity-0', 'invisible');
      chatBox.classList.remove('scale-100', 'opacity-100', 'visible');
      
      // Keep conversation history and session when closing
      // User can continue conversation when reopening
    };

    // Clear conversation function
    const clearChatHistory = () => {
      conversationHistory = [];
      sessionId = crypto.randomUUID();
      try {
        if (typeof localStorage !== 'undefined') {
          localStorage.setItem('mk_chat_session_id', sessionId);
        }
      } catch {}
      
      // Clear messages in UI
      const messagesContainer = document.getElementById('chatBoxMessages');
      if (messagesContainer) {
        messagesContainer.innerHTML = `
          <div class="flex gap-3 items-start" data-astro-cid-wqmercx5="">
            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0" data-astro-cid-wqmercx5="">M</div>
            <div class="chat-message-bubble bot-message" data-astro-cid-wqmercx5="">
              Hey there! I'm Manny ðŸ¤“ what challenge can I help you solve today?
            </div>
          </div>
        `;
      }
    };

    // Toggle chat box function
    const toggleChatBox = () => {
      if (isOpen) {
        closeChatBox();
      } else {
        openChatBox();
      }
    };

    // Event listeners
    topChatToggle?.addEventListener('click', toggleChatBox);
    dockChatToggle?.addEventListener('click', toggleChatBox);
    heroChatButton?.addEventListener('click', openChatBox);
    chatBoxClose?.addEventListener('click', closeChatBox);
    
    // Clear chat button
    document.getElementById('chatBoxClear')?.addEventListener('click', clearChatHistory);

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeChatBox();
      }
    });

    // Close when clicking outside the chat box
    document.addEventListener('click', (e) => {
      if (isOpen && chatBox && !chatBox.contains(e.target as Node)) {
        const chatToggleButtons = ['topChatToggle', 'dockChatToggle', 'heroChatButton'];
        const clickedOnToggle = chatToggleButtons.some(id => {
          const button = document.getElementById(id);
          return button && (button === e.target || button.contains(e.target as Node));
        });
        
        if (!clickedOnToggle) {
          closeChatBox();
        }
      }
    });

    // Input disabling functionality
    const setInputDisabled = (disabled: boolean) => {
      if (chatBoxInput) {
        chatBoxInput.disabled = disabled;
        chatBoxInput.style.opacity = disabled ? '0.5' : '1';
        chatBoxInput.placeholder = disabled ? 'Manny is responding...' : 'Type your message...';
      }
      if (chatBoxSend) {
        (chatBoxSend as HTMLButtonElement).disabled = disabled;
        chatBoxSend.style.opacity = disabled ? '0.5' : '1';
        chatBoxSend.style.cursor = disabled ? 'not-allowed' : 'pointer';
      }
    };

    // Send message to Manny AI
    const sendMessage = async () => {
      const message = chatBoxInput?.value.trim();
      if (!message || chatBoxInput?.disabled) return;

      const sanitizedMessage = sanitizeInput(message);
      if (!sanitizedMessage) {
        addBotMessage("I didn't quite catch that. Could you please rephrase your message?");
        return;
      }

      // Check message limit
      if (conversationHistory.length >= MAX_MESSAGES) {
        addBotMessage("I've enjoyed our conversation! For more detailed assistance, please feel free to call us or use our website analysis tool.");
        return;
      }

      // Add user message
      addUserMessage(sanitizedMessage);

      // Clear input and disable it while processing
      if (chatBoxInput) chatBoxInput.value = '';
      setInputDisabled(true);

      // Add loading indicator
      addLoadingMessage();

      try {
        // Send to Manny AI - use proper format for tool calling
    const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: sanitizedMessage,
            session_id: sessionId,
      // Provide full conversation history so the API can maintain memory
      conversation_history: conversationHistory
          })
        });

        const data = await response.json();
        
        // Remove loading indicator
        removeLoadingMessage();

        if (data.finalResponse) {
          // Add Manny's response
          addBotMessage(data.finalResponse);
          
          // Update conversation history in simple format for UI
          conversationHistory.push({role: 'user', content: sanitizedMessage});
          conversationHistory.push({role: 'assistant', content: data.finalResponse});
          
          // Keep history manageable
          if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-16);
          }
        } else if (data.reply) {
          // Fallback for old response format
          addBotMessage(data.reply);
          conversationHistory.push({role: 'user', content: sanitizedMessage});
          conversationHistory.push({role: 'assistant', content: data.reply});
        } else {
          addBotMessage("I'm having trouble connecting right now. Please try again in a moment.");
        }

        // Re-enable input after response and refocus
        setInputDisabled(false);
        setTimeout(() => chatBoxInput?.focus(), 100);

      } catch (error) {
        removeLoadingMessage();
        addBotMessage("Sorry, I encountered an error. Please try again.");
        
        // Re-enable input after error and refocus
        setInputDisabled(false);
        setTimeout(() => chatBoxInput?.focus(), 100);
      }
    };

    // Add user message to chat
    const addUserMessage = (message: string) => {
      const userMessage = document.createElement('div');
      userMessage.className = 'flex gap-3 items-start flex-row-reverse text-right';
      userMessage.setAttribute('data-astro-cid-wqmercx5', '');
      userMessage.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-blue-500 text-white font-semibold flex items-center justify-center flex-shrink-0 text-sm" data-astro-cid-wqmercx5="">U</div>
        <div class="chat-message-bubble user-message" data-astro-cid-wqmercx5="">${message}</div>
      `;
      chatBoxMessages?.appendChild(userMessage);
      scrollToBottom();
    };

    // Add bot message to chat (Manny)
    const addBotMessage = (message: string) => {
      const botResponse = document.createElement('div');
      botResponse.className = 'flex gap-3 items-start';
      botResponse.setAttribute('data-astro-cid-wqmercx5', '');
      botResponse.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0" data-astro-cid-wqmercx5="">S</div>
        <div class="chat-message-bubble bot-message" data-astro-cid-wqmercx5="">${parseMarkdown(message)}</div>
      `;
      chatBoxMessages?.appendChild(botResponse);
      scrollToBottom();
    };

    // Add loading message
    const addLoadingMessage = () => {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'flex gap-3 items-start';
      loadingDiv.id = 'loading-message';
      
      loadingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">M</div>
        <div class="chat-message-bubble bot-message">
          <div class="flex items-center gap-3">
            <div class="flex gap-1">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
              <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
              <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
            <span class="text-sm text-gray-600 dark:text-gray-400">Manny is typing...</span>
          </div>
        </div>
      `;
      
      chatBoxMessages?.appendChild(loadingDiv);
      scrollToBottom();
    };

    // Remove loading message
    const removeLoadingMessage = () => {
      const loadingMessage = document.getElementById('loading-message');
      if (loadingMessage) {
        loadingMessage.remove();
      }
    };

    // Simple markdown parser for Manny's responses
    const parseMarkdown = (text: string): string => {
      if (!text) return '';

      // 1) Markdown links: [label](https://example.com)
      let out = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (
        _match: string,
        label: string,
        url: string
      ) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
      });

      // 2) Autolink bare URLs (http(s) or www.)
      out = out.replace(/(^|[\s(>])((?:https?:\/\/|www\.)[^\s<)]+)(?=[\s<)])/g, (
        _m: string,
        pre: string,
        url: string
      ) => {
        // Avoid double-wrapping if already inside an anchor tag
        if (/^<a\b/i.test(url)) return pre + url;
        const href = url.startsWith('http') ? url : `https://${url}`;
        return `${pre}<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });

      // 3) Basic formatting
      out = out
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/<modal-link data-mode="(.*?)">(.*?)<\/modal-link>/g,
          '<button class="modal-link-button" data-mode="$1" onclick="globalOpenModal(\'$1\')">$2</button>')
        .replace(/\n/g, '<br>');

      return out;
    };

    // Scroll to bottom of messages
    const scrollToBottom = () => {
      chatBoxMessages?.scrollTo({ top: chatBoxMessages.scrollHeight, behavior: 'smooth' });
    };

    // Send on button click
    chatBoxSend?.addEventListener('click', (e) => {
      if (!(chatBoxSend as HTMLButtonElement)?.disabled) {
        sendMessage();
      }
    });

    // Send on Enter key
    chatBoxInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !chatBoxInput?.disabled) {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initChatBox, 100);
  });
</script>

<style>
  /* Chat Hub Responsive Layout */
  .chat-hub-container {
    /* Desktop: Bottom center positioning, up to 20% width */
    position: fixed;
    bottom: 6rem;
    left: 50%;
    transform: translateX(-50%);
    width: 28rem;
    height: 36rem;
    max-width: 20vw;
    min-width: 24rem;
    backdrop-filter: blur(20px);
    border: 1px solid;
    border-radius: 1rem;
  }

  /* Tablet: Half height, full width with padding */
  @media (max-width: 1024px) and (min-width: 769px) {
    .chat-hub-container {
      position: fixed;
      top: 25%;
      left: 1rem;
      right: 1rem;
      bottom: 25%;
      width: auto;
      height: auto;
      max-width: none;
      min-width: none;
      transform: none;
    }
  }

  /* Mobile: Half height, full width with padding */
  @media (max-width: 768px) {
    .chat-hub-container {
      position: fixed;
      top: 25%;
      left: 1rem;
      right: 1rem;
      bottom: 25%;
      width: auto;
      height: auto;
      max-width: none;
      min-width: none;
      border-radius: 0.75rem;
      transform: none;
    }
  }

  /* Chat body takes remaining space */
  .chat-body {
    height: calc(100% - 5rem);
  }

  /* Enhanced Green Glassmorphism - Matching dock chat button exactly */
  .chat-glassmorphism {
    /* Light mode: Clean glassmorphism with dock button green */
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
    border-color: rgba(34, 197, 94, 0.4);
    box-shadow: 0 8px 32px rgba(34, 197, 94, 0.2), 0 2px 8px rgba(34, 197, 94, 0.1);
    backdrop-filter: blur(20px);
  }

  /* Dark mode: Same as light mode for dock consistency */
  :global(.dark) .chat-glassmorphism {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
    border-color: rgba(34, 197, 94, 0.4);
    box-shadow: 0 8px 32px rgba(34, 197, 94, 0.2), 0 2px 8px rgba(34, 197, 94, 0.1);
  }

  /* Message bubbles with green theme */
  .chat-message-bubble {
    backdrop-filter: blur(20px);
    border: 1px solid rgba(34, 197, 94, 0.3);
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    color: var(--text-light-primary);
    line-height: 1.6;
    max-width: 85%;
    font-size: 0.875rem;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
  }

  .bot-message {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(34, 197, 94, 0.06));
  }

  :global(.dark) .chat-message-bubble {
    color: var(--text-dark-primary);
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(34, 197, 94, 0.06));
    border-color: rgba(34, 197, 94, 0.4);
  }

  :global(.dark) .bot-message {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
  }

  .user-message {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.06));
    border-color: rgba(59, 130, 246, 0.4);
  }

  :global(.dark) .user-message {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.08));
  }

  /* Input area with subtle green tint */
  .chat-input-area {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.03), rgba(34, 197, 94, 0.01));
  }

  :global(.dark) .chat-input-area {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(34, 197, 94, 0.02));
  }

  /* Input field with green focus states */
  .chat-input {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(34, 197, 94, 0.2);
  }

  .chat-input:focus {
    border-color: rgba(34, 197, 94, 0.5);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
  }

  :global(.dark) .chat-input {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(34, 197, 94, 0.3);
  }

  :global(.dark) .chat-input:focus {
    border-color: rgba(34, 197, 94, 0.6);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.25);
  }

  /* Chat hub animations */
  .chat-hub-container.scale-0 {
    transform: translateX(-50%) scale(0);
    transform-origin: bottom center;
  }

  .chat-hub-container.scale-100 {
    transform: translateX(-50%) scale(1);
    transform-origin: bottom center;
  }

  /* Tablet and mobile animation adjustments */
  @media (max-width: 1024px) {
    .chat-hub-container.scale-0 {
      transform: scale(0);
      transform-origin: center;
    }

    .chat-hub-container.scale-100 {
      transform: scale(1);
      transform-origin: center;
    }
  }

  /* Message width utility */
  .max-w-chat {
    max-width: 85%;
  }

  /* Scroll behavior */
  #chatBoxMessages {
    scroll-behavior: smooth;
  }

  #chatBoxMessages::-webkit-scrollbar {
    width: 4px;
  }

  #chatBoxMessages::-webkit-scrollbar-track {
    background: rgba(34, 197, 94, 0.1);
    border-radius: 2px;
  }

  #chatBoxMessages::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.3);
    border-radius: 2px;
  }

  /* Modal link buttons */
  .modal-link-button {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin: 4px 0;
    display: inline-block;
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
  }

  .modal-link-button:hover {
    background: linear-gradient(135deg, #16a34a, #15803d);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
  }

  .modal-link-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
  }

  :global(.dark) .modal-link-button {
    background: linear-gradient(135deg, #16a34a, #15803d);
    box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
  }

  :global(.dark) .modal-link-button:hover {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    box-shadow: 0 4px 8px rgba(34, 197, 94, 0.4);
  }

  #chatBoxMessages::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 197, 94, 0.5);
  }
</style>
