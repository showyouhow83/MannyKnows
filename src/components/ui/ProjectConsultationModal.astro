---
export interface Props {
  className?: string;
}

const { className = '' } = Astro.props;

// Desktop modal width variable for easy updates
const DESKTOP_MODAL_WIDTH = '80vw'; // Easy to update - can be changed to 30vw, 20vw, etc.

// Desktop modal height variable for easy updates
const DESKTOP_MODAL_HEIGHT = '90vh'; // Easy to update - can be changed to 70vh, 90vh, etc.

// Bot icon for easy customization
const BOT_ICON = 'ü§ñ'; // Easy to change: ü§ñ, üë®‚Äçüíª, üéØ, üí¨, etc.

// Get current time for dynamic greeting
const currentHour = new Date().getHours();
let greeting = 'Good morning';
if (currentHour >= 12 && currentHour < 17) {
  greeting = 'Good afternoon';
} else if (currentHour >= 17) {
  greeting = 'Good evening';
}
---

<!-- AI Business Intelligence Modal -->
<div id="consultationModal" 
     class={`fixed backdrop-blur-2xl border z-50 transform scale-0 transition-all duration-300 origin-center opacity-0 invisible ${className} consultation-glassmorphism`}
     style={`--desktop-modal-width: ${DESKTOP_MODAL_WIDTH}; --desktop-modal-height: ${DESKTOP_MODAL_HEIGHT}`}>
  <!-- Header with back button -->
  <div class="flex justify-between items-center p-0 px-6">
    <button type="button" 
            class="bg-transparent border-none text-gray-500 cursor-pointer p-2 rounded-lg transition-all duration-200 flex items-center justify-center hover:bg-green-500/10 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100" 
            id="consultationClose" 
            aria-label="Back to site">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m12 19-7-7 7-7"/>
        <path d="m19 12H5"/>
      </svg>
    </button>
    
    <div class="flex items-center gap-2">
      <button type="button" id="resetChat" class="reset-button-header" title="Reset conversation">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
          <path d="M21 3v5h-5"></path>
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
          <path d="M3 21v-5h5"></path>
        </svg>
      </button>
      <button type="button" id="expandModal" class="expand-button-header" title="Expand modal">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 18L12 14L16 18"></path>
          <path d="M8 6L12 10L16 6"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Main consultation interface -->
  <div class="flex flex-col h-full overflow-hidden">
    <!-- Content area - fixed height to prevent shifting -->
    <div class="flex-1 flex flex-col justify-center min-h-0 pt-6 px-4">
      <!-- AI business intelligence greeting -->
      <div class="text-center mb-4 flex-shrink-0">
        <div class="flex justify-center mb-4">
          <div class="pulse-container">
            <div class="pulse-bg"></div>
            <div class="bot-avatar">{BOT_ICON}</div>
          </div>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2 leading-tight">MK Business Tools</h1>
        <p class="text-lg text-gray-600 dark:text-gray-300">Choose a service or chat with our AI assistant</p>
      </div>

      <!-- Chat messages area -->
      <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 hidden min-h-0">
        <!-- Chat messages will be inserted here -->
      </div>
    </div>

    <!-- Input section - always fixed at bottom -->
    <div class="flex-shrink-0">
      <!-- Project input field -->
      <div class="mb-4">
        <label for="projectInput" class="sr-only">Describe your project idea</label>
        <div class="input-container">
          <textarea 
            id="projectInput" 
            placeholder="Ask me anything or try: analyze my website..." 
            class="project-input"
            rows="3"
          ></textarea>
          <button type="button" id="projectSubmit" class="submit-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22,2 15,22 11,13 2,9"></polygon>
            </svg>
          </button>
        </div>
      </div>

      <!-- Service shortcuts -->
      <div class="service-shortcuts">
        <div class="shortcuts-single-line">
          <span class="shortcuts-label">Or jump straight to:</span>
          <div class="shortcuts-buttons">
            <button type="button" class="service-shortcut" data-service="ai-web-scan">
              <span class="service-content">üîç FREE Website AI Analysis</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // AI Business Intelligence Modal functionality
  function initConsultationModal() {
    const modal = document.getElementById('consultationModal');
    const consultationClose = document.getElementById('consultationClose');
    const heroChatButton = document.getElementById('heroChatButton');
    const projectInput = document.getElementById('projectInput') as HTMLTextAreaElement;
    const projectSubmit = document.getElementById('projectSubmit');
    const serviceShortcuts = document.querySelectorAll('.service-shortcut');

    if (!modal) return;

    let isOpen = false;
    // Conversation state
    let conversationHistory: Array<{role: string, content: string}> = [];
    const MAX_MESSAGES = 15;
    let userMessageCount = 0;
    
    // Session management
    let sessionId = crypto.randomUUID();
    
    // Bot icon constant for JavaScript
    const BOT_ICON = 'ü§ñ';
    
    // Email verification state
    let isCollectingEmailForAnalysis = false;
    let userEmail = '';
    let isEmailVerified = false;    // Input sanitization for security
    const sanitizeInput = (input: string): string => {
      return input
        .replace(/[<>]/g, '')
        .trim()
        .substring(0, 1000);
    };

    // Email validation
    const isValidEmail = (email: string): boolean => {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.trim());
    };

    // Handle email verification workflow
    const handleEmailVerification = async (email: string): Promise<boolean> => {
      const trimmedEmail = email.trim();
      
      if (!isValidEmail(trimmedEmail)) {
        addMessage('bot', 'Please provide a valid email address so I can send you the analysis results.');
        return false;
      }

      // Store email and show verification in progress
      userEmail = trimmedEmail;
      addMessage('bot', `Perfect! I'm verifying ${userEmail} and preparing your comprehensive website analysis...`);
      
      // Add loading indicator for verification
      addLoadingMessage();
      
      try {
        // Send email verification request to API
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: `verify email: ${userEmail}`,
            session_id: sessionId,
            email: userEmail,
            mode: 'analysis'
          })
        });

        const data = await response.json();
        removeLoadingMessage();

        if (data.verification_success || data.reply) {
          isEmailVerified = true;
          isCollectingEmailForAnalysis = false;
          
          // Now proceed with the actual analysis
          addMessage('bot', 'Email verified! Running your comprehensive AI website analysis now...');
          
          // Add user message for analysis request and trigger analysis
          setTimeout(() => {
            const analysisMessage = "I'd like a comprehensive AI web analysis of my website";
            addMessage('user', analysisMessage);
            addLoadingMessage();
            
            // Send analysis request
            handleAnalysisSubmission(analysisMessage);
          }, 1000);
          
          return true;
        } else {
          addMessage('bot', 'There was an issue with email verification. Please try again or contact us directly.');
          return false;
        }
      } catch (error) {
        removeLoadingMessage();
        addMessage('bot', 'There was an issue with email verification. Please try again or contact us directly.');
        return false;
      }
    };

    // Handle the actual analysis submission (separate from regular chat)
    const handleAnalysisSubmission = async (projectText: string) => {
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: projectText,
            session_id: sessionId,
            email: userEmail,
            mode: 'analysis',
            conversation_history: conversationHistory
          })
        });

        const data = await response.json();
        removeLoadingMessage();
        
        if (data.reply) {
          addMessage('bot', data.reply);
          
          // Add to conversation history
          conversationHistory.push({ role: 'user', content: projectText });
          conversationHistory.push({ role: 'assistant', content: data.reply });
        } else if (data.error) {
          addMessage('bot', 'I encountered an issue running the analysis. Please try again or contact us directly.');
        }
      } catch (error) {
        removeLoadingMessage();
        addMessage('bot', 'I encountered an issue running the analysis. Please try again or contact us directly.');
      }
    };

    // Simple Markdown to HTML conversion for chat messages
    const parseMarkdown = (text: string): string => {
      return text
        // Bold text: **text** -> <strong>text</strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Bullet points: ‚Ä¢ or - at start of line -> proper list items
        .replace(/^[‚Ä¢\-]\s+(.+)/gm, '<li>$1</li>')
        // Wrap consecutive list items in <ul>
        .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
        // Fix nested ul tags
        .replace(/<\/ul>\s*<ul>/g, '')
        // Line breaks: double newlines -> paragraph breaks
        .replace(/\n\n/g, '</p><p>')
        // Wrap in paragraphs
        .replace(/^(.)/gm, '<p>$1')
        .replace(/(.)\n$/gm, '$1</p>')
        // Clean up empty paragraphs
        .replace(/<p><\/p>/g, '');
    };

    // Open consultation modal
    const openModal = (mode?: 'analysis' | 'chat') => {
      if (isOpen) return;
      isOpen = true;
      modal.classList.remove('scale-0', 'opacity-0', 'invisible');
      modal.classList.add('scale-100', 'opacity-100', 'visible');
      
      // Hide floating dock when modal is open
      const floatingDock = document.getElementById('floatingDock');
      if (floatingDock) {
        floatingDock.style.display = 'none';
      }

      // If opening in analysis mode, start the analysis conversation
      if (mode === 'analysis') {
        startAnalysisMode();
      }
      
      // Focus on input after modal opens
      setTimeout(() => projectInput?.focus(), 300);
    };

    // Start analysis mode - first collect and verify email
    const startAnalysisMode = () => {
      // Show chat area and hide greeting 
      const chatMessages = document.getElementById('chatMessages');
      const greetingSection = document.querySelector('.text-center.mb-4.flex-shrink-0');
      
      if (chatMessages && greetingSection) {
        greetingSection.classList.add('hidden');
        chatMessages.classList.remove('hidden');
      }
      
      // Start with email collection for analysis
      const welcomeMessage = "Hi! I'd love to run a comprehensive AI analysis of your website. To get started, please provide your email address so I can send you the detailed results.";
      addMessage('bot', welcomeMessage);
      
      // Set flag to indicate we're in email collection mode for analysis
      isCollectingEmailForAnalysis = true;
    };

    // Make openModal globally accessible for hash navigation
    globalOpenModal = openModal;

    // Close consultation modal
    const closeModal = () => {
      if (!isOpen) return;
      isOpen = false;
      modal.classList.add('scale-0', 'opacity-0', 'invisible');
      modal.classList.remove('scale-100', 'opacity-100', 'visible');
      
      // Reset conversation when closing modal
      conversationHistory = [];
      userMessageCount = 0;
      sessionId = crypto.randomUUID();
      
      // Show floating dock when modal is closed
      const floatingDock = document.getElementById('floatingDock');
      if (floatingDock) {
        floatingDock.style.display = '';
      }
    };

    // Toggle modal function
    const toggleModal = () => {
      if (isOpen) {
        closeModal();
      } else {
        openModal();
      }
    };

    // Reset conversation function
    const resetConversation = () => {
      const chatMessages = document.getElementById('chatMessages');
      const greetingSection = document.querySelector('.text-center.mb-4.flex-shrink-0');
      
      if (chatMessages) {
        chatMessages.innerHTML = '';
        chatMessages.classList.add('hidden');
      }
      
      if (projectInput) {
        projectInput.value = '';
        projectInput.style.height = 'auto';
      }
      
      // Reset conversation state and generate new session
      conversationHistory = [];
      userMessageCount = 0;
      sessionId = crypto.randomUUID();
      
      // Show greeting section again
      if (greetingSection) {
        greetingSection.classList.remove('hidden');
      }
    };

    // Toggle fullscreen function
    const toggleFullscreen = () => {
      // Only allow fullscreen on desktop (1111px+)
      if (window.innerWidth < 1111) {
        return;
      }
      
      const modal = document.getElementById('consultationModal');
      if (!modal) return;
      
      const isFullscreen = modal.classList.contains('fullscreen-modal');
      
      if (isFullscreen) {
        // Exit fullscreen
        modal.classList.remove('fullscreen-modal');
        modal.style.width = '';
        modal.style.height = '';
        // Update expand button icon to expand
        const expandButton = document.getElementById('expandModal');
        if (expandButton) {
          expandButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M8 18L12 14L16 18"></path>
              <path d="M8 6L12 10L16 6"></path>
            </svg>
          `;
          expandButton.title = 'Expand modal';
        }
      } else {
        // Enter fullscreen
        modal.classList.add('fullscreen-modal');
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        // Update expand button icon to contract
        const expandButton = document.getElementById('expandModal');
        if (expandButton) {
          expandButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 6L12 10L8 6"></path>
              <path d="M16 18L12 14L8 18"></path>
            </svg>
          `;
          expandButton.title = 'Contract modal';
        }
      }
    };

    // Handle project submission
    const handleProjectSubmission = async (projectText: string, serviceType?: string) => {
      const sanitizedText = sanitizeInput(projectText);
      if (!sanitizedText && !serviceType) return;

      // If we're collecting email for analysis, handle that workflow
      if (isCollectingEmailForAnalysis) {
        // Add user's email input as a message
        addMessage('user', sanitizedText);
        await handleEmailVerification(sanitizedText);
        return;
      }

      // Check message limit before sending
      if (userMessageCount >= MAX_MESSAGES) {
        addMessage('bot', `I've enjoyed our conversation! After ${MAX_MESSAGES} messages, I'd love to connect you directly with Manny for a proper consultation. Please call us at (555) 123-4567 or email hello@mannyknows.com üìû`);
        return;
      }

      // Increment user message count
      userMessageCount++;

      // Show chat area and hide greeting
      const chatMessages = document.getElementById('chatMessages');
      const greetingSection = document.querySelector('.text-center.mb-4.flex-shrink-0');
      
      if (chatMessages && greetingSection) {
        greetingSection.classList.add('hidden');
        chatMessages.classList.remove('hidden');
      }

      // Add user message
      const userMessage = sanitizedText || `I'm interested in ${serviceType}`;
      addMessage('user', userMessage);

      // Clear input
      if (projectInput) projectInput.value = '';

      // Add loading indicator
      addLoadingMessage();

      // Send to API
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: userMessage,
            session_id: sessionId,
            // Removed hardcoded model to rely on server environment configuration
            conversation_history: conversationHistory
          })
        });

        const data = await response.json();
        
        // Remove loading indicator
        removeLoadingMessage();
        
        if (data.reply) {
          // Add user message to history
          conversationHistory.push({ role: 'user', content: userMessage });
          // Add bot response to history  
          conversationHistory.push({ role: 'assistant', content: data.reply });
          
          addMessage('bot', data.reply);
          
          // If chatbot is offline, show contact info and disable input
          if (data.chatbot_offline) {
            const projectInput = document.getElementById('projectInput') as HTMLInputElement;
            if (projectInput) {
              projectInput.disabled = true;
              projectInput.placeholder = 'Chatbot offline - please contact us directly';
            }
          }
          
          // If message limit reached, disable input
          if (data.message_limit_reached) {
            const projectInput = document.getElementById('projectInput') as HTMLInputElement;
            if (projectInput) {
              projectInput.disabled = true;
              projectInput.placeholder = 'Please contact us directly to continue...';
            }
          }
        }
      } catch (error) {
        // Remove loading indicator
        removeLoadingMessage();
        // Silent error handling in production
        addMessage('bot', 'Sorry, I encountered an error. Please try again.');
      }
    };

    // Add message to chat
    const addMessage = (sender: 'user' | 'bot', message: string) => {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = `mb-6 ${sender === 'user' ? 'flex justify-end' : 'flex justify-start'}`;
      
      const bubbleClass = sender === 'user' 
        ? 'bg-green-500 text-white shadow-lg chat-bubble-user'
        : 'bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-lg border border-gray-200 dark:border-gray-700 chat-bubble-bot';
      
      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="inline-block p-4 max-w-[85%] ${bubbleClass}">
            ${message}
          </div>
        `;
      } else {
        // Bot message with avatar
        messageDiv.innerHTML = `
          <div class="flex items-start gap-3 max-w-[85%]">
            <div class="bot-avatar-small flex-shrink-0">${BOT_ICON}</div>
            <div class="inline-block p-4 ${bubbleClass}">
              ${parseMarkdown(message)}
            </div>
          </div>
        `;
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // Add loading message
    const addLoadingMessage = () => {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;

      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'mb-6 flex justify-start';
      loadingDiv.id = 'loading-message';
      
      loadingDiv.innerHTML = `
        <div class="flex items-start gap-3 max-w-[85%]">
          <div class="bot-avatar-small flex-shrink-0">${BOT_ICON}</div>
          <div class="inline-block p-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-lg border border-gray-200 dark:border-gray-700 chat-bubble-bot">
            <div class="flex items-center gap-3">
              <div class="flex gap-1">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
              </div>
              <span class="text-sm text-gray-600 dark:text-gray-400">Analyzing your request...</span>
            </div>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(loadingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // Remove loading message
    const removeLoadingMessage = () => {
      const loadingMessage = document.getElementById('loading-message');
      if (loadingMessage) {
        loadingMessage.remove();
      }
    };

    // Event listeners - only hero button opens modal, chat buttons handled by ChatWindow
    heroChatButton?.addEventListener('click', () => openModal()); // Hero button only opens
    // consultationClose click handler moved below with blur handling

    // Close when clicking outside the modal
    document.addEventListener('click', (e) => {
      if (isOpen && modal && !modal.contains(e.target as Node)) {
        // Don't close if clicking on hero button or analysis button
        const isHeroButton = heroChatButton && (heroChatButton === e.target || heroChatButton.contains(e.target as Node));
        const isAnalysisButton = (e.target as HTMLElement)?.closest('a[href="#apple-quote"]');
        
        if (!isHeroButton && !isAnalysisButton) {
          closeModal();
        }
      }
    });

    // Project submission - moved to service shortcuts section with blur handling

    // Service shortcuts mapping with compelling prompts
    const serviceMapping = {
      'ai-web-scan': {
        name: 'AI Web Intelligence Scan',
        prompt: 'Run a deep AI analysis on my website - I want to see hidden performance issues, SEO gaps, and revenue optimization opportunities that most tools miss.'
      },
      'market-intelligence': {
        name: 'Market Intelligence Report', 
        prompt: 'I need a competitive intelligence report - show me what my competitors are doing better and where I can outmaneuver them in the market.'
      },
      'marketing-audit': {
        name: 'Digital Presence Audit',
        prompt: 'Audit my entire digital marketing presence - I want to know what\'s working, what\'s broken, and where I\'m bleeding potential customers.'
      },
      'growth-optimizer': {
        name: 'Growth Acceleration Analysis',
        prompt: 'I\'m ready to scale my business - analyze my growth bottlenecks and show me the fastest path to increase revenue.'
      },
      'consulting': {
        name: 'Business Strategy Consultation',
        prompt: 'I need strategic business guidance - help me identify my biggest opportunities and create a roadmap for success.'
      }
    };

    // Service shortcuts
    serviceShortcuts.forEach(button => {
      button.addEventListener('click', () => {
        const serviceType = button.getAttribute('data-service');
        const serviceData = serviceMapping[serviceType as keyof typeof serviceMapping];
        
        if (serviceData) {
          handleProjectSubmission(serviceData.prompt, serviceType || undefined);
        } else {
          // Fallback for any unmapped services
          const fallbackText = button.textContent?.trim() || '';
          handleProjectSubmission(`I'm interested in ${fallbackText}`, serviceType || undefined);
        }
        
        // Blur the button to remove focus state after click (prevents stuck hover on touch devices)
        (button as HTMLElement).blur();
      });
    });

    // Submit button blur handling
    projectSubmit?.addEventListener('click', () => {
      const projectText = projectInput?.value.trim() || '';
      handleProjectSubmission(projectText);
      
      // Blur the button to remove focus state after click
      (projectSubmit as HTMLElement).blur();
    });

    // Reset button
    const resetButton = document.getElementById('resetChat');
    resetButton?.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent event bubbling
      resetConversation();
      (resetButton as HTMLElement).blur();
    });

    // Expand button
    const expandButton = document.getElementById('expandModal');
    expandButton?.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent event bubbling that might close modal
      toggleFullscreen();
      (expandButton as HTMLElement).blur();
    });

    // Back button blur handling  
    consultationClose?.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent event bubbling
      closeModal();
      
      // Blur the button to remove focus state after click
      (consultationClose as HTMLElement).blur();
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeModal();
      }
    });

    // Submit on Enter (or Ctrl/Cmd + Enter for new line)
    projectInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        // Enter alone sends the message
        e.preventDefault();
        const projectText = projectInput.value.trim();
        if (projectText) {
          handleProjectSubmission(projectText);
        }
      } else if (e.key === 'Enter' && e.shiftKey) {
        // Shift + Enter adds a new line (default behavior)
        // Allow default behavior
      }
    });

    // Auto-resize textarea
    projectInput?.addEventListener('input', () => {
      projectInput.style.height = 'auto';
      projectInput.style.height = Math.min(projectInput.scrollHeight, 120) + 'px';
    });
  }

  // Global variable to store openModal function
  let globalOpenModal: ((mode?: 'analysis' | 'chat') => void) | null = null;

  // Check for apple-quote hash to trigger analysis mode
  const checkForAnalysisMode = () => {
    if (window.location.hash === '#apple-quote') {
      // Remove the hash from URL
      history.replaceState(null, '', window.location.pathname);
      // Open modal in analysis mode
      if (globalOpenModal) {
        globalOpenModal('analysis');
      } else {
        // Retry after a short delay if modal isn't ready
        setTimeout(checkForAnalysisMode, 100);
      }
    }
  };

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      initConsultationModal();
      checkForAnalysisMode();
    }, 100);
  });

  // Also check for hash on window load (in case DOM loads before hash is set)
  window.addEventListener('load', checkForAnalysisMode);
  
  // Listen for hash changes
  window.addEventListener('hashchange', checkForAnalysisMode);
</script>

<style>
  /* Consultation Modal Responsive Layout */
  #consultationModal {
    position: fixed;
    backdrop-filter: blur(24px);
    border: 1px solid;
    z-index: 50;
  }

  /* Mobile: Full screen with proper padding (375px+) */
  @media (max-width: 424px) {
    #consultationModal {
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      border-radius: 0;
      padding: 1rem;
      padding-bottom: 5rem; /* Extra space for dock */
      transform: none !important;
    }
  }

  /* Tablet: Full screen modal (425px - 1024px) */
  @media (min-width: 425px) and (max-width: 1024px) {
    #consultationModal {
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      border-radius: 0;
      padding: 2rem;
      padding-bottom: 5rem; /* Extra space for dock */
      transform: none !important;
    }
  }
  /* Desktop: Variable width modal (1025px+) */
  @media (min-width: 1025px) {
    #consultationModal {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: var(--desktop-modal-width);
      height: var(--desktop-modal-height);
      min-width: 400px;
      max-height: 90vh;
      border-radius: 1rem;
      padding: 1.5rem;
      padding-bottom: 4rem; /* Much more room for button on desktop */
      margin: 2rem;
    }
  }

  /* Fullscreen modal override */
  #consultationModal.fullscreen-modal {
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: none !important;
    max-height: none !important;
    transform: none !important;
    border-radius: 0 !important;
    margin: 0 !important;
    padding: 2rem !important;
  }

  @media (max-width: 768px) {
    #consultationModal.fullscreen-modal {
      padding: 1rem !important;
    }
  }

  /* Show expand button only on screens 1111px+ */
  @media (min-width: 1111px) {
    .expand-button-header {
      display: flex !important;
    }
  }

  @media (max-width: 1110px) {
    .expand-button-header {
      display: none !important;
    }
  }

  /* Glassmorphism styling */
  .consultation-glassmorphism {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
    border-color: rgba(34, 197, 94, 0.3);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.15), 0 4px 12px rgba(34, 197, 94, 0.1);
  }

  :global(.dark) .consultation-glassmorphism {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(34, 197, 94, 0.06));
    border-color: rgba(34, 197, 94, 0.4);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2), 0 4px 12px rgba(34, 197, 94, 0.15);
  }

  /* Header */
  .consultation-header {
    padding: 0rem 1.5rem 0;
    display: flex;
    justify-content: flex-start;
  }

  .back-button {
    background: none;
    border: none;
    color: var(--text-light-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .back-button:hover {
    background: rgba(34, 197, 94, 0.1);
    color: var(--text-light-primary);
  }

  /* Prevent stuck hover states on touch devices */
  @media (hover: none) {
    .back-button:hover {
      background: none;
      color: var(--text-light-secondary);
    }
  }

  :global(.dark) .back-button {
    color: var(--text-dark-secondary);
  }

  :global(.dark) .back-button:hover {
    color: var(--text-dark-primary);
  }

  /* Prevent stuck hover states on touch devices - dark mode */
  @media (hover: none) {
    :global(.dark) .back-button:hover {
      color: var(--text-dark-secondary);
    }
  }

  /* Main content */
  .consultation-content {
    padding: 2rem 1.5rem;
    height: calc(100% - 4rem);
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Greeting section */
  .greeting-section {
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .greeting-icon {
    display: flex;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .pulse-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
  }

  .pulse-bg {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, #22c55e, #10b981);
    border-radius: 50%;
    animation: pulse 2s infinite;
    opacity: 0.3;
  }

  .bot-avatar {
    position: relative;
    font-size: 2rem;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
  }

  :global(.dark) .bot-avatar {
    background: rgba(30, 41, 59, 0.9);
  }

  .greeting-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-light-primary);
    margin: 0 0 0.5rem 0;
    line-height: 1.2;
  }

  .greeting-subtitle {
    font-size: 1.125rem;
    color: var(--text-light-secondary);
    margin: 0;
  }

  :global(.dark) .greeting-title {
    color: var(--text-dark-primary);
  }

  :global(.dark) .greeting-subtitle {
    color: var(--text-dark-secondary);
  }

  /* Project input section */
  .project-input-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .input-container {
    position: relative;
    display: flex;
    align-items: flex-end;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 0.75rem;
    transition: all 0.3s ease;
  }

  .input-container:focus-within {
    border-color: rgba(34, 197, 94, 0.6);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
  }

  :global(.dark) .input-container {
    background: rgba(30, 41, 59, 0.7);
    border-color: rgba(34, 197, 94, 0.4);
  }

  .project-input {
    flex: 1;
    min-height: 100px;
    padding: 1rem;
    border: none;
    border-radius: 0.75rem;
    background: transparent;
    color: var(--text-light-primary);
    font-size: 1rem;
    line-height: 1.5;
    resize: none;
    font-family: inherit;
    outline: none;
  }

  .project-input::placeholder {
    color: var(--text-light-tertiary);
  }

  :global(.dark) .project-input {
    color: var(--text-dark-primary);
  }

  :global(.dark) .project-input::placeholder {
    color: var(--text-dark-tertiary);
  }

  .button-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0.5rem;
  }

  .reset-button,
  .expand-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .expand-button {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border-color: rgba(59, 130, 246, 0.2);
  }

  .reset-button:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: translateY(-1px);
  }

  .expand-button:hover {
    background: rgba(59, 130, 246, 0.2);
    transform: translateY(-1px);
  }

  /* Header button variants */
  .reset-button-header,
  .expand-button-header {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .expand-button-header {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border-color: rgba(59, 130, 246, 0.2);
  }

  .reset-button-header:hover {
    background: rgba(239, 68, 68, 0.15);
    transform: translateY(-1px);
  }

  .expand-button-header:hover {
    background: rgba(59, 130, 246, 0.15);
    transform: translateY(-1px);
  }

  /* Prevent stuck hover states on touch devices */
  @media (hover: none) {
    .reset-button:hover,
    .expand-button:hover,
    .reset-button-header:hover,
    .expand-button-header:hover {
      transform: none;
    }
  }

  .submit-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    margin: 0.5rem;
    background: linear-gradient(135deg, #22c55e, #10b981);
    color: white;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .submit-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
  }

  /* Prevent stuck hover states on touch devices */
  @media (hover: none) {
    .submit-button:hover {
      transform: none;
      box-shadow: none;
    }
  }

  /* Service shortcuts */
  .service-shortcuts {
    /* Removed margin-top: auto; since shortcuts now follow input directly */
  }

  .shortcuts-single-line {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .shortcuts-label {
    color: var(--text-light-secondary);
    font-size: 0.875rem;
    margin: 0;
    flex-shrink: 0;
  }

  :global(.dark) .shortcuts-label {
    color: var(--text-dark-secondary);
  }

  .shortcuts-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* Mobile: Stack label and buttons */
  @media (max-width: 640px) {
    .shortcuts-single-line {
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .shortcuts-buttons {
      gap: 0.5rem;
    }
  }

  .service-shortcut {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0.75rem;
    background: rgba(34, 197, 94, 0.05);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 0.5rem;
    color: var(--text-light-primary);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    white-space: nowrap;
    flex: 0 0 auto;
  }

  .service-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .service-shortcut:hover {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.4);
    transform: translateY(-1px);
  }

  /* Prevent stuck hover states on touch devices */
  @media (hover: none) {
    .service-shortcut:hover {
      background: rgba(34, 197, 94, 0.05);
      border-color: rgba(34, 197, 94, 0.2);
      transform: none;
    }
  }

  .service-icon {
    font-size: 1.125rem;
    margin-right: 0.25rem;
  }

  :global(.dark) .service-shortcut {
    color: var(--text-dark-primary);
    background: rgba(34, 197, 94, 0.08);
    border-color: rgba(34, 197, 94, 0.3);
  }

  :global(.dark) .service-shortcut:hover {
    background: rgba(34, 197, 94, 0.15);
    border-color: rgba(34, 197, 94, 0.5);
  }

  /* Prevent stuck hover states on touch devices - dark mode */
  @media (hover: none) {
    :global(.dark) .service-shortcut:hover {
      background: rgba(34, 197, 94, 0.08);
      border-color: rgba(34, 197, 94, 0.3);
    }
  }

  /* Animations */
  #consultationModal.scale-0 {
    transform: translate(-50%, -50%) scale(0);
  }

  #consultationModal.scale-100 {
    transform: translate(-50%, -50%) scale(1);
  }

  /* Mobile and tablet animation adjustments */
  @media (max-width: 1024px) {
    #consultationModal.scale-0 {
      transform: scale(0) !important;
    }

    #consultationModal.scale-100 {
      transform: scale(1) !important;
    }
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.7;
      transform: scale(1.1);
    }
  }

  /* Chat Bubble Styles */
  .chat-bubble-user {
    border-radius: 1.25rem 1.25rem 0.375rem 1.25rem;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    transform: translateY(0);
    transition: all 0.2s ease;
    white-space: pre-wrap; /* Preserve line breaks and formatting */
    word-wrap: break-word; /* Handle long words */
  }

  .chat-bubble-user:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.25);
  }

  .chat-bubble-bot {
    border-radius: 1.25rem 1.25rem 1.25rem 0.375rem;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
    transform: translateY(0);
    transition: all 0.2s ease;
    white-space: pre-wrap; /* Preserve line breaks and formatting */
    word-wrap: break-word; /* Handle long words */
  }

  .chat-bubble-bot:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  :global(.dark) .chat-bubble-bot {
    background: rgba(30, 41, 59, 0.95);
    border-color: rgba(55, 65, 81, 0.5);
  }

  :global(.dark) .chat-bubble-bot:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }

  /* Prevent hover effects on touch devices */
  @media (hover: none) {
    .chat-bubble-user:hover,
    .chat-bubble-bot:hover {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
    }
    
    :global(.dark) .chat-bubble-bot:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
  }

  /* Bot Avatar Small */
  .bot-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: white;
    font-weight: 500;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    transition: all 0.2s ease;
  }

  .bot-avatar-small:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
  }

  /* Markdown formatting styles for chat messages */
  .chat-bubble-bot ul {
    margin: 0.5rem 0;
    padding-left: 0;
    list-style: none;
  }

  .chat-bubble-bot li {
    margin: 0.25rem 0;
    padding-left: 1rem;
    position: relative;
  }

  .chat-bubble-bot li::before {
    content: "‚Ä¢";
    color: #22c55e;
    font-weight: bold;
    position: absolute;
    left: 0;
  }

  .chat-bubble-bot strong {
    font-weight: 600;
    color: #16a34a;
  }

  :global(.dark) .chat-bubble-bot strong {
    color: #22c55e;
  }

  .chat-bubble-bot p {
    margin: 0.5rem 0;
  }

  .chat-bubble-bot p:first-child {
    margin-top: 0;
  }

  .chat-bubble-bot p:last-child {
    margin-bottom: 0;
  }
</style>
