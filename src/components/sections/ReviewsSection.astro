---
import ReviewCard from '../ui/ReviewCard.astro';
import Section from '../layout/Section.astro';
import Container from '../layout/Container.astro';
import SectionHeader from '../ui/SectionHeader.astro';
import StatsCard from '../ui/StatsCard.astro';
import Button from '../ui/Button.astro';

// Reviews data
const reviews = [
  {
    customerName: "Sarah Chen",
    testimonial: "MannyKnows transformed our online store completely. Our conversion rates increased by 340% within 3 months, and the AI automation saves us 20+ hours weekly.",
    tags: [
      { label: "AI E-commerce", color: "blue" as const },
      { label: "Automation", color: "purple" as const },
      { label: "Analytics", color: "pink" as const }
    ]
  },
  {
    customerName: "Marcus Rodriguez",
    testimonial: "The product photography service is incredible. Our product pages look professional and sales have doubled. The team understands e-commerce visual needs perfectly.",
    tags: [
      { label: "Photography", color: "green" as const },
      { label: "Product Visuals", color: "blue" as const },
      { label: "Brand Design", color: "purple" as const }
    ]
  },
  {
    customerName: "Emily Watson",
    testimonial: "Custom AI integration revolutionized our customer support. Response time dropped 90% while satisfaction scores hit all-time highs. Exceptional technical expertise.",
    tags: [
      { label: "AI Integration", color: "purple" as const },
      { label: "Customer Support", color: "blue" as const },
      { label: "Automation", color: "green" as const }
    ]
  },
  {
    customerName: "David Kim",
    testimonial: "Our new website is blazing fast and converts like crazy. Mobile sales jumped 280% and our SEO rankings skyrocketed. Best investment we've made!",
    tags: [
      { label: "Web Development", color: "blue" as const },
      { label: "SEO", color: "green" as const },
      { label: "Mobile Optimization", color: "purple" as const }
    ]
  },
  {
    customerName: "Lisa Thompson",
    testimonial: "The social media automation is phenomenal. Our engagement tripled and we're generating 5x more qualified leads. The analytics insights are game-changing.",
    tags: [
      { label: "Social Media", color: "pink" as const },
      { label: "Automation", color: "purple" as const },
      { label: "Lead Generation", color: "blue" as const }
    ]
  },
  {
    customerName: "Robert Chen",
    testimonial: "Analytics & reporting gave us crystal clear insights into customer behavior. We optimized our funnel and saw a 420% increase in lifetime value!",
    tags: [
      { label: "Analytics", color: "blue" as const },
      { label: "Reporting", color: "purple" as const },
      { label: "Optimization", color: "green" as const }
    ]
  },
  {
    customerName: "Amanda Foster",
    testimonial: "The content creation service transformed our brand voice. Blog traffic increased 6x and we're now ranking #1 for our main keywords. Outstanding quality and strategy.",
    tags: [
      { label: "Content Creation", color: "blue" as const },
      { label: "SEO Content", color: "green" as const },
      { label: "Brand Strategy", color: "purple" as const }
    ]
  }
];

// Stats data
const stats = [
  { value: "4+", label: "Happy Clients" },
  { value: "135%", label: "Avg. Sales Increase" },
  { value: "100%", label: "Client Satisfaction" },
  { value: "24/7", label: "Human Support" }
];
---

<Section id="reviews" variant="default" hasOverflow={true}>
  <Container className="relative z-10">
    <div id="reviews-section">
      <SectionHeader
        title="Customer Success Stories"
        subtitle="Discover how businesses like yours achieved remarkable growth with our AI-powered e-commerce solutions."
      />

    <!-- Reviews Carousel Container -->
    <div class="relative mb-12">

      <!-- Reviews Container -->
      <div class="py-4">
        <!-- Mobile: Single card view -->
        <div class="block md:hidden px-8">
          <div id="reviewsContainerMobile" class="flex transition-transform duration-300 ease-in-out">
            {reviews.map((review) => {
              // Get primary color for glassmorphism effect
              const primaryColor = review.tags[0]?.color === 'blue' ? '#3b82f6' :
                                   review.tags[0]?.color === 'green' ? '#22c55e' :
                                   review.tags[0]?.color === 'purple' ? '#8b5cf6' :
                                   review.tags[0]?.color === 'pink' ? '#ec4899' :
                                   '#3b82f6';
              
              return (
                <div class="w-full flex-shrink-0 px-2">
                  <div class="backdrop-blur-lg border rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:-translate-y-2 group relative overflow-hidden"
                       style={`background: linear-gradient(135deg, ${primaryColor}15, ${primaryColor}08); border-color: ${primaryColor}40; box-shadow: 0 4px 20px ${primaryColor}20, 0 1px 3px ${primaryColor}10;`}>
                    
                    <!-- Enhanced glassmorphism overlay on hover -->
                    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
                         style={`background: linear-gradient(135deg, ${primaryColor}08, ${primaryColor}05);`}></div>
                    
                    <!-- Card content with proper z-index -->
                    <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-1">
                          {Array.from({ length: 5 }, () => (
                            <svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 24 24">
                              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                          ))}
                        </div>
                        <div class="text-sm font-medium text-text-light-primary dark:text-text-dark-primary">{review.customerName}</div>
                      </div>
                      <blockquote class="text-text-light-primary dark:text-text-dark-primary text-lg leading-relaxed mb-6 font-medium">
                        "{review.testimonial}"
                      </blockquote>
                      <div class="flex flex-wrap gap-2">
                        {review.tags.map((tag) => (
                          <span class={`px-3 py-1 text-xs font-medium rounded-full border 
                            ${tag.color === 'blue' ? 'bg-blue-500/10 text-blue-500 border-blue-500/20' : ''}
                            ${tag.color === 'green' ? 'bg-green-500/10 text-green-500 border-green-500/20' : ''}
                            ${tag.color === 'purple' ? 'bg-purple-500/10 text-purple-500 border-purple-500/20' : ''}
                            ${tag.color === 'pink' ? 'bg-pink-500/10 text-pink-500 border-pink-500/20' : ''}
                          `}>
                            {tag.label}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <!-- Desktop: Multi-card view -->
        <div class="hidden md:block px-16">
          <div id="reviewsContainer" class="flex gap-8 transition-transform duration-500 ease-in-out">
            {reviews.map((review) => (
              <ReviewCard {...review} />
            ))}
          </div>
        </div>
      </div>
    </div>

      <!-- Carousel Navigation -->
      <div class="flex justify-center gap-6 mb-16">
        <button id="prevReview" class="flex items-center justify-center w-12 h-12 bg-white/80 dark:bg-white/10 backdrop-blur-lg border border-gray-200/50 dark:border-white/10 rounded-full text-text-light-primary dark:text-text-dark-primary transition-all duration-300 hover:scale-110 hover:bg-primary-blue/20 hover:border-primary-blue/30" aria-label="Previous review">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <polyline points="15,18 9,12 15,6"/>
          </svg>
        </button>
        <button id="nextReview" class="flex items-center justify-center w-12 h-12 bg-white/80 dark:bg-white/10 backdrop-blur-lg border border-gray-200/50 dark:border-white/10 rounded-full text-text-light-primary dark:text-text-dark-primary transition-all duration-300 hover:scale-110 hover:bg-primary-blue/20 hover:border-primary-blue/30" aria-label="Next review">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <polyline points="9,18 15,12 9,6"/>
          </svg>
        </button>
      </div>

    <!-- Stats Section -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-16">
      {stats.map((stat) => (
        <StatsCard {...stat} />
      ))}
    </div>

    <!-- Call to Action -->
    <div class="text-center">
      <Button 
        href="/contact-us" 
        text="Join Our Success Stories" 
        variant="cta" 
        size="lg" 
        arrow={true}
        sparkleTheme='cyan' />
    </div>
    </div>
  </Container>
</Section>

<style>
  /* Reviews section animations - Enhanced for glassmorphism cards */
  .group {
    transform: translateY(0);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Enhanced hover effects that work with dynamic colors via inline styles */
  .group:hover {
    transform: translateY(-8px) scale(1.05);
    /* Shadow is now handled by inline styles for dynamic colors */
  }

  /* Carousel specific styles */
  #reviewsContainer {
    transition: transform 0.3s ease-in-out;
  }

  #reviewsContainerMobile {
    transition: transform 0.3s ease-out;
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  #reviewsContainerMobile:active {
    cursor: grabbing;
  }

  .review-card {
    flex-shrink: 0;
  }

  /* Navigation buttons with enhanced glassmorphism */
  #prevReview, #nextReview {
    backdrop-filter: blur(16px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  #prevReview:hover, #nextReview:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 40px rgba(16, 209, 255, 0.2);
    backdrop-filter: blur(20px);
  }

  /* Dots indicator */
  .carousel-dot {
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .carousel-dot:hover {
    transform: scale(1.2);
  }

  /* Star rating animations */
  svg {
    transition: all 0.2s ease;
  }

  .group:hover svg {
    transform: scale(1.1);
    filter: drop-shadow(0 0 8px rgba(255, 193, 7, 0.6));
  }

  /* Glassmorphism shimmer effect on hover */
  .group::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
    pointer-events: none;
    z-index: 1;
  }

  .group:hover::before {
    left: 100%;
  }
</style>

<script>
  function initReviewsSection() {
    // Separate carousel functionality for mobile and desktop
    const containerMobile = document.getElementById('reviewsContainerMobile');
    const containerDesktop = document.getElementById('reviewsContainer');
    const prevBtn = document.getElementById('prevReview');
    const nextBtn = document.getElementById('nextReview');
    const reviewsSection = document.getElementById('reviews-section');

    if (!prevBtn || !nextBtn || !reviewsSection) return;

    let currentIndexMobile = 0;
    let currentIndexDesktop = 0;
    let isScrollControlled = false;
    
    // Touch scrolling variables for mobile
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    let startTime = 0;
    
    // Mobile carousel (1 card at a time)
    function updateMobileCarousel() {
      if (!containerMobile) return;
      const firstSlide = containerMobile.children[0] as HTMLElement;
      const slideWidth = firstSlide?.offsetWidth || 0;
      const translateX = -currentIndexMobile * slideWidth;
      containerMobile.style.transform = `translateX(${translateX}px)`;
    }

    // Desktop carousel (3 cards at a time) 
    function updateDesktopCarousel() {
      if (!containerDesktop) return;
      const card = containerDesktop.children[0] as HTMLElement;
      const cardWidth = card ? card.offsetWidth + 32 : 0; // card width + margin
      const translateX = -currentIndexDesktop * cardWidth;
      containerDesktop.style.transform = `translateX(${translateX}px)`;
    }

    function nextSlide() {
      const isMobile = window.innerWidth < 768;
      
      if (isMobile && containerMobile) {
        const totalCards = containerMobile.children.length;
        currentIndexMobile = (currentIndexMobile + 1) % totalCards;
        updateMobileCarousel();
      } else if (containerDesktop) {
        const totalCards = containerDesktop.children.length;
        const maxIndex = Math.max(0, totalCards - 3); // Show 3 cards on desktop
        currentIndexDesktop = currentIndexDesktop >= maxIndex ? 0 : currentIndexDesktop + 1;
        updateDesktopCarousel();
      }
    }

    function prevSlide() {
      const isMobile = window.innerWidth < 768;
      
      if (isMobile && containerMobile) {
        const totalCards = containerMobile.children.length;
        currentIndexMobile = currentIndexMobile === 0 ? totalCards - 1 : currentIndexMobile - 1;
        updateMobileCarousel();
      } else if (containerDesktop) {
        const totalCards = containerDesktop.children.length;
        const maxIndex = Math.max(0, totalCards - 3);
        currentIndexDesktop = currentIndexDesktop <= 0 ? maxIndex : currentIndexDesktop - 1;
        updateDesktopCarousel();
      }
    }

    // SCROLL-CONTROLLED REVIEWS - What you actually asked for!
    function scrollToReviewIndex(targetIndex: number) {
      const isMobile = window.innerWidth < 768;
      
      if (isMobile && containerMobile) {
        currentIndexMobile = Math.max(0, Math.min(targetIndex, containerMobile.children.length - 1));
        updateMobileCarousel();
      } else if (containerDesktop) {
        const totalCards = containerDesktop.children.length;
        const maxIndex = Math.max(0, totalCards - 3);
        currentIndexDesktop = Math.max(0, Math.min(targetIndex, maxIndex));
        updateDesktopCarousel();
      }
    }

    function initScrollControlledReviews() {
      if (!reviewsSection) return;
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
            isScrollControlled = true;
            startScrollListener();
          } else {
            isScrollControlled = false;
          }
        });
      }, {
        threshold: [0.5, 0.8],
        rootMargin: '-20% 0px -20% 0px'
      });

      observer.observe(reviewsSection);
    }

    function startScrollListener() {
      let lastScrollTime = 0;
      
      function handleScroll() {
        if (!isScrollControlled || !reviewsSection) return;
        
        const now = Date.now();
        if (now - lastScrollTime < 16) return; // Throttle to ~60fps
        lastScrollTime = now;

        const rect = reviewsSection.getBoundingClientRect();
        const sectionHeight = rect.height;
        const viewportHeight = window.innerHeight;
        
        // Calculate how far through the section we've scrolled
        const scrollProgress = Math.max(0, Math.min(1, 
          (viewportHeight - rect.top - 100) / (sectionHeight + viewportHeight - 200)
        ));

        // Map scroll progress to review index
        const isMobile = window.innerWidth < 768;
        const totalReviews = isMobile ? 
          (containerMobile?.children.length || 5) : 
          Math.max(0, (containerDesktop?.children.length || 5) - 2);
        
        const targetIndex = Math.floor(scrollProgress * totalReviews);
        
        // Only update if the index changed
        const currentIndex = isMobile ? currentIndexMobile : currentIndexDesktop;
        if (targetIndex !== currentIndex) {
          scrollToReviewIndex(targetIndex);
        }
      }

      window.addEventListener('scroll', handleScroll, { passive: true });
    }

    function updateCarousel() {
      const isMobile = window.innerWidth < 768;
      if (isMobile) {
        updateMobileCarousel();
      } else {
        updateDesktopCarousel();
      }
    }

    // Touch scrolling for mobile
    function initTouchScrolling() {
      if (!containerMobile) return;
      
      // Touch start
      containerMobile.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        currentX = startX;
        isDragging = true;
        startTime = Date.now();
        containerMobile.style.transition = 'none';
      }, { passive: true });
      
      // Touch move
      containerMobile.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        currentX = e.touches[0].clientX;
        const diffX = currentX - startX;
        const currentTransform = -currentIndexMobile * (containerMobile.children[0] as HTMLElement)?.offsetWidth || 0;
        
        containerMobile.style.transform = `translateX(${currentTransform + diffX}px)`;
      }, { passive: true });
      
      // Touch end
      containerMobile.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        
        isDragging = false;
        containerMobile.style.transition = 'transform 0.3s ease-out';
        
        const diffX = currentX - startX;
        const threshold = 50; // Minimum swipe distance
        const timeDiff = Date.now() - startTime;
        const velocity = Math.abs(diffX) / timeDiff;
        
        // Determine if it's a valid swipe
        if (Math.abs(diffX) > threshold || velocity > 0.5) {
          if (diffX > 0) {
            // Swipe right - go to previous
            prevSlide();
          } else {
            // Swipe left - go to next
            nextSlide();
          }
        } else {
          // Snap back to current position
          updateMobileCarousel();
        }
      }, { passive: true });
      
      // Mouse events for desktop touch devices (mobile container only)
      containerMobile.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        currentX = startX;
        isDragging = true;
        startTime = Date.now();
        containerMobile.style.transition = 'none';
        e.preventDefault();
      });
      
      containerMobile.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        currentX = e.clientX;
        const diffX = currentX - startX;
        const currentTransform = -currentIndexMobile * (containerMobile.children[0] as HTMLElement)?.offsetWidth || 0;
        
        containerMobile.style.transform = `translateX(${currentTransform + diffX}px)`;
        e.preventDefault();
      });
      
      containerMobile.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        
        isDragging = false;
        containerMobile.style.transition = 'transform 0.3s ease-out';
        
        const diffX = currentX - startX;
        const threshold = 50;
        const timeDiff = Date.now() - startTime;
        const velocity = Math.abs(diffX) / timeDiff;
        
        if (Math.abs(diffX) > threshold || velocity > 0.5) {
          if (diffX > 0) {
            prevSlide();
          } else {
            nextSlide();
          }
        } else {
          updateMobileCarousel();
        }
        e.preventDefault();
      });
      
      // Prevent context menu on long press
      containerMobile.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });
    }

    // Mouse drag scrolling for desktop
    function initDesktopMouseDrag() {
      if (!containerDesktop) return;
      
      // Mouse events for desktop drag scrolling
      containerDesktop.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        currentX = startX;
        isDragging = true;
        startTime = Date.now();
        containerDesktop.style.transition = 'none';
        containerDesktop.style.cursor = 'grabbing';
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        currentX = e.clientX;
        const diffX = currentX - startX;
        const card = containerDesktop.children[0] as HTMLElement;
        const cardWidth = card ? card.offsetWidth + 32 : 400; // Use actual card width + gap
        const currentTransform = -currentIndexDesktop * cardWidth;
        
        containerDesktop.style.transform = `translateX(${currentTransform + diffX}px)`;
        e.preventDefault();
      });
      
      document.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        
        isDragging = false;
        containerDesktop.style.transition = 'transform 0.5s ease-in-out';
        containerDesktop.style.cursor = 'grab';
        
        const diffX = currentX - startX;
        const threshold = 30; // Reduced threshold for more sensitivity
        const timeDiff = Date.now() - startTime;
        const velocity = Math.abs(diffX) / timeDiff;
        
        if (Math.abs(diffX) > threshold || velocity > 0.3) { // Reduced velocity threshold
          if (diffX > 0) {
            prevSlide();
          } else {
            nextSlide();
          }
        } else {
          updateDesktopCarousel();
        }
        e.preventDefault();
      });

      // Handle mouse leave to stop dragging
      containerDesktop.addEventListener('mouseleave', (e) => {
        if (!isDragging) return;
        
        isDragging = false;
        containerDesktop.style.transition = 'transform 0.5s ease-in-out';
        containerDesktop.style.cursor = 'grab';
        updateDesktopCarousel();
      });
      
      // Prevent context menu on long press
      containerDesktop.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });

      // Set initial cursor
      containerDesktop.style.cursor = 'grab';
    }

    // Event listeners
    nextBtn.addEventListener('click', nextSlide);
    prevBtn.addEventListener('click', prevSlide);

    // Initialize
    updateCarousel();
    initTouchScrolling(); // Enable touch scrolling for mobile
    initDesktopMouseDrag(); // Enable mouse drag scrolling for desktop
    // initScrollControlledReviews(); // DISABLED - Scroll animations removed per user request

    // Handle resize
    window.addEventListener('resize', () => {
      updateCarousel();
    });

    // Analytics tracking removed for simplicity
  }

  // Initialize when DOM is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initReviewsSection);
  } else {
    initReviewsSection();
  }
</script>