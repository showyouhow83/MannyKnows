---
// PostHog Analytics Configuration
interface Props {
  // Core PostHog settings
  enabled?: boolean;
  apiKey?: string;
  apiHost?: string;
  
  // Feature toggles
  webVitalsEnabled?: boolean;
  sessionRecordingEnabled?: boolean;
  autocaptureEnabled?: boolean;
  capturePageViews?: boolean;
  
  // Debug and development
  debugMode?: boolean;
  disableInDevelopment?: boolean;
}

const {
  // Core settings
  enabled = true,
  apiKey = 'phc_P3zXU8812VuDNHqwWhcGo8dYcU7tg7fItSCqnAGJk9R',
  apiHost = 'https://us.i.posthog.com',
  
  // Feature toggles with sensible defaults
---
// PostHog Analytics Configuration - OPTIMIZED
interface Props {
  enabled?: boolean;
  webVitalsEnabled?: boolean;
  sessionRecordingEnabled?: boolean;
  autocaptureEnabled?: boolean;
  capturePageViews?: boolean;
  debugMode?: boolean;
  disableInDevelopment?: boolean;
}

const {
  enabled = true,
  webVitalsEnabled = false, // DISABLED for performance
  sessionRecordingEnabled = false,
  autocaptureEnabled = true,
  capturePageViews = true,
  debugMode = false,
  disableInDevelopment = true
} = Astro.props;

// Skip if disabled
if (!enabled || (disableInDevelopment && import.meta.env.DEV)) {
  return;
}
---

<!-- MINIMAL PostHog Analytics -->
<script define:vars={{ autocaptureEnabled, capturePageViews, debugMode }}>
  (function(){
    const apiKey = "phc_P3zXU8812VuDNHqwWhcGo8dYcU7tg7fItSCqnAGJk9R"; 
    const apiHost = "https://us.i.posthog.com";
    
    // Minimal PostHog loader
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){(p=t.createElement("script")).async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;u.people=u.people||[],o="capture identify register".split(" ");for(n=0;n<o.length;n++)u[o[n]]=function(){u.push([o[n]].concat(Array.prototype.slice.call(arguments,0)))};e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    
    posthog.init(apiKey, {
      api_host: apiHost,
      autocapture: autocaptureEnabled,
      capture_pageview: capturePageViews,
      disable_session_recording: true,
      debug: debugMode,
      request_batching: true,
      batch_request_timeout_ms: 2000, // Slower for efficiency
      disable_surveys: true,
      disable_toolbar: true
    });

    if (debugMode) {
      console.log('ðŸš€ PostHog (minimal) loaded');
    }
  })();
</script>

// Log when PostHog is disabled in development
if (isDevelopment && disableInDevelopment) {
  console.log('ðŸ“Š PostHog disabled in development environment');
}
---

{!shouldDisable && (
  <script type="text/javascript" define:vars={{ 
    apiKey, 
    apiHost, 
    webVitalsEnabled, 
    sessionRecordingEnabled, 
    autocaptureEnabled, 
    capturePageViews,
    debugMode 
  }}>
    // PostHog initialization
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]);t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    
    posthog.init(apiKey, {
      api_host: apiHost,
      
      // Core features
      autocapture: autocaptureEnabled,
      capture_pageview: capturePageViews,
      
      // Session recording
      disable_session_recording: !sessionRecordingEnabled,
      
      // Debug mode
      debug: debugMode,
      
      // Performance optimizations
      request_batching: true,
      batch_request_timeout_ms: 500,
      
      // Privacy settings
      respect_dnt: true,
      opt_out_capturing_by_default: false,
      
      // Disable features we don't need for better performance
      disable_surveys: true,
      disable_toolbar: !debugMode
    });

    // Web Vitals tracking (configurable)
    if (webVitalsEnabled) {
      // Core Web Vitals tracking with web-vitals library or manual implementation
      function trackWebVitals() {
        // Track CLS (Cumulative Layout Shift)
        if ('PerformanceObserver' in window) {
          try {
            const clsObserver = new PerformanceObserver((list) => {
              for (const entry of list.getEntries()) {
                if (!entry.hadRecentInput) {
                  posthog.capture('web_vital_cls', {
                    value: entry.value,
                    rating: entry.value > 0.25 ? 'poor' : entry.value > 0.1 ? 'needs-improvement' : 'good'
                  });
                }
              }
            });
            clsObserver.observe({ type: 'layout-shift', buffered: true });
          } catch (e) {
            if (debugMode) console.warn('CLS tracking failed:', e);
          }

          // Track LCP (Largest Contentful Paint)
          try {
            const lcpObserver = new PerformanceObserver((list) => {
              const entries = list.getEntries();
              const lastEntry = entries[entries.length - 1];
              posthog.capture('web_vital_lcp', {
                value: lastEntry.startTime,
                rating: lastEntry.startTime > 4000 ? 'poor' : lastEntry.startTime > 2500 ? 'needs-improvement' : 'good'
              });
            });
            lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });
          } catch (e) {
            if (debugMode) console.warn('LCP tracking failed:', e);
          }

          // Track FID (First Input Delay)
          try {
            const fidObserver = new PerformanceObserver((list) => {
              for (const entry of list.getEntries()) {
                posthog.capture('web_vital_fid', {
                  value: entry.processingStart - entry.startTime,
                  rating: (entry.processingStart - entry.startTime) > 300 ? 'poor' : (entry.processingStart - entry.startTime) > 100 ? 'needs-improvement' : 'good'
                });
              }
            });
            fidObserver.observe({ type: 'first-input', buffered: true });
          } catch (e) {
            if (debugMode) console.warn('FID tracking failed:', e);
          }
        }

        // Track page load time
        window.addEventListener('load', () => {
          const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
          posthog.capture('page_load_time', {
            value: loadTime,
            rating: loadTime > 3000 ? 'poor' : loadTime > 1000 ? 'needs-improvement' : 'good'
          });
        });
      }

      // Initialize Web Vitals tracking
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', trackWebVitals);
      } else {
        trackWebVitals();
      }
    }

    // Track basic user engagement
    if (capturePageViews) {
      // Track scroll depth
      let maxScrollDepth = 0;
      const trackScrollDepth = () => {
        const scrollDepth = Math.round((window.scrollY + window.innerHeight) / document.body.scrollHeight * 100);
        if (scrollDepth > maxScrollDepth) {
          maxScrollDepth = scrollDepth;
          if (maxScrollDepth >= 25 && maxScrollDepth % 25 === 0) {
            posthog.capture('scroll_depth', { depth: maxScrollDepth });
          }
        }
      };
      
      window.addEventListener('scroll', () => {
        clearTimeout(window.scrollTimer);
        window.scrollTimer = setTimeout(trackScrollDepth, 150);
      }, { passive: true });
    }

    if (debugMode) {
      console.log('ðŸš€ PostHog initialized with features:', {
        webVitals: webVitalsEnabled,
        sessionRecording: sessionRecordingEnabled,
        autocapture: autocaptureEnabled,
        pageViews: capturePageViews
      });
    }
  </script>
)}
