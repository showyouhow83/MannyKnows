---
// Settings modal component for user preferences
// Optimized for static-first delivery with deferred interactivity
import Skeleton from './ui/Skeleton.astro';
---

<!-- Settings Modal -->
<div 
  id="settingsModal" 
  class="fixed inset-0 bg-black/50 dark:bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 invisible transition-all duration-300"
  role="dialog"
  aria-labelledby="settingsTitle"
  aria-modal="true"
>
  <!-- Settings Modal Content with skeleton loading -->
  <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-lg border border-gray-300/50 dark:border-white/10 rounded-2xl shadow-2xl max-w-md w-full mx-4 transform scale-95 transition-all duration-300">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200/50 dark:border-white/10">
      <h2 id="settingsTitle" class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600 dark:text-gray-400">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"/>
        </svg>
        Settings
      </h2>
      <button 
        id="closeSettings" 
        class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors duration-200 p-1 rounded-lg hover:bg-gray-100/50 dark:hover:bg-white/10"
        aria-label="Close settings"
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Settings Content -->
    <div class="p-6 space-y-6">
      
      <!-- Theme Setting -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-lg flex items-center justify-center">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600 dark:text-blue-400">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </div>
          <div>
            <label for="themeToggle" class="text-sm font-semibold text-gray-800 dark:text-white cursor-pointer">
              Dark Mode
            </label>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">
              Switch between light and dark themes
            </p>
          </div>
        </div>
        <div class="flex items-center">
          <!-- Show skeleton while loading -->
          <noscript>
            <Skeleton variant="toggle" />
          </noscript>
          <label class="relative inline-flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              id="themeToggle" 
              class="sr-only peer"
              checked
            >
            <div class="relative w-14 h-8 bg-gray-200 dark:bg-gray-700 rounded-full peer-focus:ring-4 peer-focus:ring-blue-300/30 dark:peer-focus:ring-blue-800/30 transition-all duration-300 peer-checked:bg-gradient-to-r peer-checked:from-blue-500 peer-checked:to-indigo-600 shadow-inner">
              <div class="absolute top-0.5 left-0.5 w-7 h-7 bg-white rounded-full shadow-lg transform transition-transform duration-300 peer-checked:translate-x-6 flex items-center justify-center">
                <svg class="absolute w-4 h-4 text-yellow-500 transition-opacity duration-200 opacity-100 peer-checked:opacity-0" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                </svg>
                <svg class="absolute w-4 h-4 text-slate-700 transition-opacity duration-200 opacity-0 peer-checked:opacity-100" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                </svg>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Marquee Setting -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-green-500/20 to-emerald-500/20 rounded-lg flex items-center justify-center">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600 dark:text-green-400">
              <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2z"/>
              <path d="M8 21l4-7 4 7M13 10V7"/>
            </svg>
          </div>
          <div>
            <label for="marqueeToggle" class="text-sm font-semibold text-gray-800 dark:text-white cursor-pointer">
              Show Marquee
            </label>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">
              Display the animated text marquee
            </p>
          </div>
        </div>
        <div class="flex items-center">
          <label class="relative inline-flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              id="marqueeToggle" 
              class="sr-only peer"
              checked
            >
            <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300/50 dark:peer-focus:ring-green-800/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all duration-300 peer-checked:bg-gradient-to-r peer-checked:from-green-500 peer-checked:to-emerald-500"></div>
          </label>
        </div>
      </div>

      <!-- Colorful Titles Setting -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-lg flex items-center justify-center">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600 dark:text-purple-400">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
          <div>
            <label for="colorfulTitlesToggle" class="text-sm font-semibold text-gray-800 dark:text-white cursor-pointer">
              Colorful Titles
            </label>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">
              Show gradient and animated text colors
            </p>
          </div>
        </div>
        <div class="flex items-center">
          <label class="relative inline-flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              id="colorfulTitlesToggle" 
              class="sr-only peer"
              checked
            >
            <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300/50 dark:peer-focus:ring-purple-800/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all duration-300 peer-checked:bg-gradient-to-r peer-checked:from-purple-500 peer-checked:to-pink-500"></div>
          </label>
        </div>
      </div>

      <!-- Analytics Notice -->
      <div class="bg-blue-50/50 dark:bg-blue-900/20 border border-blue-200/50 dark:border-blue-400/20 rounded-lg p-4">
        <div class="flex items-start gap-3">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
          </svg>
          <div>
            <p class="text-xs font-medium text-blue-800 dark:text-blue-200">
              Privacy Notice
            </p>
            <p class="text-xs text-blue-700 dark:text-blue-300 mt-1">
              Your preferences help us improve the site experience. Settings are stored locally and anonymized usage data may be collected.
            </p>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div class="flex justify-end gap-3 p-6 pt-0">
      <button 
        id="resetSettings" 
        class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200"
      >
        Reset to Default
      </button>
      <button 
        id="saveSettings" 
        class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200"
      >
        Save Changes
      </button>
    </div>
  </div>
</div>

<script>
  import { devLog, perfLog, errorLog } from '../utils/debug.ts';

  // Define apply functions globally so they're available when DOM loads
  function applyMarqueeSetting(enabled: boolean) {
    const marquees = document.querySelectorAll('[data-marquee]') as NodeListOf<HTMLElement>;
    marquees.forEach(marquee => {
      if (enabled) {
        marquee.style.display = '';
      } else {
        marquee.style.display = 'none';
      }
    });
  }

  function applyColorfulTitlesSetting(enabled: boolean) {
    const colorfulElements = document.querySelectorAll('.apple-gradient-text, [data-colorful-title]') as NodeListOf<HTMLElement>;
    
    colorfulElements.forEach((element, index) => {
      if (enabled) {
        element.classList.remove('colorful-disabled');
        // Remove any inline styles that might override
        element.style.removeProperty('background');
        element.style.removeProperty('background-image');
        element.style.removeProperty('background-size');
        element.style.removeProperty('-webkit-background-clip');
        element.style.removeProperty('background-clip');
        element.style.removeProperty('-webkit-text-fill-color');
        element.style.removeProperty('animation');
        element.style.removeProperty('color');
      } else {
        element.classList.add('colorful-disabled');
        // Force inline styles as backup
        const isDark = document.documentElement.classList.contains('dark');
        element.style.setProperty('background', 'none', 'important');
        element.style.setProperty('background-image', 'none', 'important');
        element.style.setProperty('background-size', 'initial', 'important');
        element.style.setProperty('-webkit-background-clip', 'initial', 'important');
        element.style.setProperty('background-clip', 'initial', 'important');
        element.style.setProperty('-webkit-text-fill-color', 'initial', 'important');
        element.style.setProperty('animation', 'none', 'important');
        // Apply correct color based on theme: dark text for light mode, light text for dark mode
        element.style.setProperty('color', isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgb(31, 41, 55)', 'important');
      }
    });
  }

  function applyThemeSetting(isDark: boolean) {
    const html = document.documentElement;
    
    if (isDark) {
      html.classList.add('dark');
    } else {
      html.classList.remove('dark');
    }
    
    // Dispatch custom event for theme change (for all theme changes)
    document.dispatchEvent(new CustomEvent('themeChanged', {
      detail: { 
        isDark: isDark,
        source: 'theme_system'
      }
    }));
    
    // Update the colorful titles if they're disabled to match new theme
    const colorfulTitlesEnabled = localStorage.getItem('colorful-titles-enabled') !== 'false';
    if (!colorfulTitlesEnabled) {
      applyColorfulTitlesSetting(false);
    }
  }

  // Function to apply settings on page load
  function applyGlobalSettings() {
    const marqueeEnabled = localStorage.getItem('marquee-enabled') !== 'false';
    const colorfulTitlesEnabled = localStorage.getItem('colorful-titles-enabled') !== 'false';
    
    devLog('ðŸŽ¯ Loading global settings:', { marqueeEnabled, colorfulTitlesEnabled });
    
    // Apply marquee setting
    applyMarqueeSetting(marqueeEnabled);
    
    // Apply colorful titles setting
    applyColorfulTitlesSetting(colorfulTitlesEnabled);
  }

  function initSettingsModal() {
    devLog('ðŸŽ¯ initSettingsModal() called');
    
    // Modal elements (might not exist if using mobile-only design)
    const modal = document.getElementById('settingsModal') as HTMLElement;
    const openButton = document.getElementById('settingsButton') as HTMLElement;
    const closeButton = document.getElementById('closeSettings') as HTMLButtonElement;
    const saveButton = document.getElementById('saveSettings') as HTMLButtonElement;
    const resetButton = document.getElementById('resetSettings') as HTMLButtonElement;
    const marqueeToggle = document.getElementById('marqueeToggle') as HTMLInputElement;
    const colorfulTitlesToggle = document.getElementById('colorfulTitlesToggle') as HTMLInputElement;
    const themeToggle = document.getElementById('themeToggle') as HTMLInputElement;
    
    // Mobile panel elements (primary implementation)
    const mobileThemeToggle = document.getElementById('mobileThemeToggle') as HTMLInputElement;
    const mobileMarqueeToggle = document.getElementById('mobileMarqueeToggle') as HTMLInputElement;
    // Note: Mobile panel doesn't have colorful titles toggle in current implementation
    
    devLog('ðŸŽ¯ Elements found:', {
      modal: !!modal,
      openButton: !!openButton,
      closeButton: !!closeButton,
      marqueeToggle: !!marqueeToggle,
      colorfulTitlesToggle: !!colorfulTitlesToggle,
      themeToggle: !!themeToggle,
      mobileThemeToggle: !!mobileThemeToggle,
      mobileMarqueeToggle: !!mobileMarqueeToggle
    });
    
    // If modal exists, set it up (optional)
    if (modal && openButton) {
      devLog('ðŸŽ¯ Setting up modal functionality');
      // ... existing modal setup code ...
      
      // Open modal
      openButton.addEventListener('click', () => {
        modal.classList.remove('opacity-0', 'invisible');
        const modalDialog = modal.querySelector('div') as HTMLElement;
        modalDialog?.classList.remove('scale-95');
        modalDialog?.classList.add('scale-100');
        document.body.style.overflow = 'hidden';
        
        // Modal opened - tracking could be added here
      });

      // Close modal function
      function closeModal() {
        modal.classList.add('opacity-0', 'invisible');
        const modalDialog = modal.querySelector('div') as HTMLElement;
        modalDialog?.classList.add('scale-95');
        modalDialog?.classList.remove('scale-100');
        document.body.style.overflow = '';
      }

      // Close modal events
      closeButton?.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // Escape key to close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('invisible')) {
          closeModal();
        }
      });

      // Save settings
      saveButton?.addEventListener('click', () => {
        saveSettings();
        closeModal();
      });

      // Reset settings
      resetButton?.addEventListener('click', () => {
        resetSettings();
      });
    } else {
      devLog('ðŸŽ¯ Modal not found, using mobile panel only');
    }

    // Load saved preferences
    loadSettings();

    // Real-time toggle updates with immediate saving
    if (marqueeToggle) {
      devLog('ðŸŽ¯ Adding marquee toggle event listener');
      marqueeToggle.addEventListener('change', () => {
        devLog('ðŸŽ¯ Marquee toggle changed:', marqueeToggle.checked);
        applyMarqueeSetting(marqueeToggle.checked);
        // Save immediately to localStorage
        localStorage.setItem('marquee-enabled', marqueeToggle.checked.toString());
        
        // Setting change tracking could be added here
      });
    } else {
      devLog('ðŸš¨ Marquee toggle not found!');
    }

    if (colorfulTitlesToggle) {
      devLog('ðŸŽ¯ Adding colorful titles toggle event listener');
      colorfulTitlesToggle.addEventListener('change', () => {
        devLog('ðŸŽ¯ Colorful titles toggle changed:', colorfulTitlesToggle.checked);
        applyColorfulTitlesSetting(colorfulTitlesToggle.checked);
        // Save immediately to localStorage
        localStorage.setItem('colorful-titles-enabled', colorfulTitlesToggle.checked.toString());
        
        // Setting change tracking could be added here
      });
    } else {
      devLog('ðŸš¨ Colorful titles toggle not found!');
    }

    if (themeToggle) {
      devLog('ðŸŽ¯ Adding theme toggle event listener');
      themeToggle.addEventListener('change', () => {
        devLog('ðŸŽ¯ Theme toggle changed:', themeToggle.checked);
        applyThemeSetting(themeToggle.checked);
        // Save immediately to localStorage
        localStorage.setItem('theme-dark', themeToggle.checked.toString());
        
        // Dispatch custom event for theme change
        document.dispatchEvent(new CustomEvent('themeChanged', {
          detail: { 
            isDark: themeToggle.checked,
            source: 'settings_toggle'
          }
        }));
        
        // Setting change tracking could be added here
      });
    } else {
      devLog('ðŸš¨ Theme toggle not found!');
    }

    // Mobile toggle event listeners (primary implementation)
    if (mobileThemeToggle) {
      devLog('ðŸŽ¯ Adding mobile theme toggle event listener');
      mobileThemeToggle.addEventListener('change', () => {
        devLog('ðŸŽ¯ Mobile theme toggle changed:', mobileThemeToggle.checked);
        applyThemeSetting(mobileThemeToggle.checked);
        // Save immediately to localStorage
        localStorage.setItem('theme-dark', mobileThemeToggle.checked.toString());
        
        // Sync with modal toggle if it exists
        if (themeToggle) {
          themeToggle.checked = mobileThemeToggle.checked;
        }
        
        // Dispatch custom event for theme change
        document.dispatchEvent(new CustomEvent('themeChanged', {
          detail: { 
            isDark: mobileThemeToggle.checked,
            source: 'mobile_settings_toggle'
          }
        }));
      });
    } else {
      devLog('ðŸš¨ Mobile theme toggle not found!');
    }

    if (mobileMarqueeToggle) {
      devLog('ðŸŽ¯ Adding mobile marquee toggle event listener');
      mobileMarqueeToggle.addEventListener('change', () => {
        devLog('ðŸŽ¯ Mobile marquee toggle changed:', mobileMarqueeToggle.checked);
        applyMarqueeSetting(mobileMarqueeToggle.checked);
        // Save immediately to localStorage
        localStorage.setItem('marquee-enabled', mobileMarqueeToggle.checked.toString());
        
        // Sync with modal toggle if it exists
        if (marqueeToggle) {
          marqueeToggle.checked = mobileMarqueeToggle.checked;
        }
      });
    } else {
      devLog('ðŸš¨ Mobile marquee toggle not found!');
    }

    function loadSettings() {
      const marqueeEnabled = localStorage.getItem('marquee-enabled') !== 'false';
      const colorfulTitlesEnabled = localStorage.getItem('colorful-titles-enabled') !== 'false';
      // Default to dark mode unless explicitly set to light
      const themeDark = localStorage.getItem('theme-dark') !== 'false';
      
      devLog('ðŸŽ¯ Loading settings', { themeDark, marqueeEnabled, colorfulTitlesEnabled });
      
      // Modal toggles (if they exist)
      if (marqueeToggle) {
        marqueeToggle.checked = marqueeEnabled;
        applyMarqueeSetting(marqueeEnabled);
      }
      
      if (colorfulTitlesToggle) {
        colorfulTitlesToggle.checked = colorfulTitlesEnabled;
        applyColorfulTitlesSetting(colorfulTitlesEnabled);
      }
      
      if (themeToggle) {
        themeToggle.checked = themeDark;
        applyThemeSetting(themeDark);
      }
      
      // Mobile panel toggles (primary implementation)
      if (mobileThemeToggle) {
        devLog('ðŸŽ¯ Setting mobile theme toggle to:', themeDark);
        mobileThemeToggle.checked = themeDark;
      }
      
      if (mobileMarqueeToggle) {
        devLog('ðŸŽ¯ Setting mobile marquee toggle to:', marqueeEnabled);
        mobileMarqueeToggle.checked = marqueeEnabled;
      }
    }

    function saveSettings() {
      // Settings are now saved in real-time, this just tracks the save button click
      const marqueeEnabled = marqueeToggle?.checked ?? true;
      const colorfulTitlesEnabled = colorfulTitlesToggle?.checked ?? true;
      const themeDark = themeToggle?.checked ?? true; // Default to dark mode
      
      // Settings save tracking could be added here
    }

    function resetSettings() {
      // Reset localStorage
      localStorage.setItem('marquee-enabled', 'true');
      localStorage.setItem('colorful-titles-enabled', 'true');
      localStorage.removeItem('theme-dark'); // Let system preference take over
      
      // Reset toggle states
      if (marqueeToggle) marqueeToggle.checked = true;
      if (colorfulTitlesToggle) colorfulTitlesToggle.checked = true;
      if (themeToggle) {
        // Default to dark mode by design
        themeToggle.checked = true;
        applyThemeSetting(true);
      }
      
      // Apply default settings
      applyMarqueeSetting(true);
      applyColorfulTitlesSetting(true);
      
      // Settings reset tracking could be added here
    }

    // Listen for theme changes and update colorful titles if they're disabled
    function handleThemeChange() {
      const colorfulTitlesEnabled = localStorage.getItem('colorful-titles-enabled') !== 'false';
      if (!colorfulTitlesEnabled) {
        // Reapply the disabled state with updated colors for the new theme
        applyColorfulTitlesSetting(false);
      }
    }

    // Set up theme change listener
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const target = mutation.target;
          if (target === document.documentElement) {
            handleThemeChange();
          }
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    devLog('ðŸŽ¯ DOM loaded, initializing settings...');
    
    // Debug: Let's see if the mobile toggles exist and work
    setTimeout(() => {
      const mobileTheme = document.getElementById('mobileThemeToggle') as HTMLInputElement;
      const mobileMarquee = document.getElementById('mobileMarqueeToggle') as HTMLInputElement;
      
      devLog('ðŸ” DEBUGGING - Mobile theme toggle found:', !!mobileTheme);
      devLog('ðŸ” DEBUGGING - Mobile marquee toggle found:', !!mobileMarquee);
      
      if (mobileTheme) {
        devLog('ðŸ” DEBUGGING - Theme toggle checked state:', mobileTheme.checked);
        devLog('ðŸ” DEBUGGING - Theme toggle classes:', mobileTheme.className);
        
        // Add proper event handlers that call apply functions
        mobileTheme.addEventListener('click', () => {
          devLog('ðŸ”¥ THEME TOGGLE CLICKED! New state:', mobileTheme.checked);
          // Call the apply function
          applyThemeSetting(mobileTheme.checked);
          // Save to localStorage
          localStorage.setItem('theme-dark', mobileTheme.checked.toString());
        });
        
        mobileTheme.addEventListener('change', () => {
          devLog('ðŸ”¥ THEME TOGGLE CHANGED! New state:', mobileTheme.checked);
          // Call the apply function
          applyThemeSetting(mobileTheme.checked);
          // Save to localStorage
          localStorage.setItem('theme-dark', mobileTheme.checked.toString());
        });
      }
      
      if (mobileMarquee) {
        devLog('ðŸ” DEBUGGING - Marquee toggle checked state:', mobileMarquee.checked);
        
        // Add proper event handlers that call apply functions
        mobileMarquee.addEventListener('click', () => {
          devLog('ðŸ”¥ MARQUEE TOGGLE CLICKED! New state:', mobileMarquee.checked);
          // Call the apply function
          applyMarqueeSetting(mobileMarquee.checked);
          // Save to localStorage
          localStorage.setItem('marquee-enabled', mobileMarquee.checked.toString());
        });
        
        mobileMarquee.addEventListener('change', () => {
          devLog('ðŸ”¥ MARQUEE TOGGLE CHANGED! New state:', mobileMarquee.checked);
          // Call the apply function
          applyMarqueeSetting(mobileMarquee.checked);
          // Save to localStorage
          localStorage.setItem('marquee-enabled', mobileMarquee.checked.toString());
        });
      }
      
      // Get mobile colorful titles toggle and add event handlers
      const mobileColorfulTitles = document.getElementById('mobileColorfulTitlesToggle') as HTMLInputElement;
      if (mobileColorfulTitles) {
        devLog('ðŸ” DEBUGGING - Mobile colorful titles toggle checked state:', mobileColorfulTitles.checked);
        
        // Add proper event handlers that call apply functions
        mobileColorfulTitles.addEventListener('click', () => {
          devLog('ðŸ”¥ MOBILE COLORFUL TITLES TOGGLE CLICKED! New state:', mobileColorfulTitles.checked);
          // Call the apply function
          applyColorfulTitlesSetting(mobileColorfulTitles.checked);
          // Save to localStorage
          localStorage.setItem('colorful-titles-enabled', mobileColorfulTitles.checked.toString());
        });
        
        mobileColorfulTitles.addEventListener('change', () => {
          devLog('ðŸ”¥ MOBILE COLORFUL TITLES TOGGLE CHANGED! New state:', mobileColorfulTitles.checked);
          // Call the apply function
          applyColorfulTitlesSetting(mobileColorfulTitles.checked);
          // Save to localStorage
          localStorage.setItem('colorful-titles-enabled', mobileColorfulTitles.checked.toString());
        });
      }
      
    }, 500); // Wait longer to ensure everything is loaded
    
    // Wait a bit for all elements to be ready, then apply global settings
    setTimeout(() => {
      devLog('ðŸŽ¯ Applying global settings...');
      applyGlobalSettings();
      
      // Initialize modal after settings are applied
      initSettingsModal();
    }, 100);
  });
</script>

<style>
  /* High specificity override for colorful titles when disabled */
  .apple-gradient-text.colorful-disabled,
  [data-colorful-title].colorful-disabled {
    background: none !important;
    background-image: none !important;
    background-size: initial !important;
    -webkit-background-clip: initial !important;
    background-clip: initial !important;
    -webkit-text-fill-color: initial !important;
    animation: none !important;
    color: rgb(31, 41, 55) !important; /* dark text for light mode */
  }
  
  .dark .apple-gradient-text.colorful-disabled,
  .dark [data-colorful-title].colorful-disabled {
    color: rgba(255, 255, 255, 0.95) !important; /* light text for dark mode */
  }
  
  /* Additional specificity for nested elements */
  h1 .apple-gradient-text.colorful-disabled,
  h2 .apple-gradient-text.colorful-disabled,
  h3 .apple-gradient-text.colorful-disabled,
  h4 .apple-gradient-text.colorful-disabled,
  h5 .apple-gradient-text.colorful-disabled,
  h6 .apple-gradient-text.colorful-disabled,
  span.apple-gradient-text.colorful-disabled {
    background: none !important;
    background-image: none !important;
    background-size: initial !important;
    -webkit-background-clip: initial !important;
    background-clip: initial !important;
    -webkit-text-fill-color: initial !important;
    animation: none !important;
    color: rgb(31, 41, 55) !important; /* dark text for light mode */
  }
  
  .dark h1 .apple-gradient-text.colorful-disabled,
  .dark h2 .apple-gradient-text.colorful-disabled,
  .dark h3 .apple-gradient-text.colorful-disabled,
  .dark h4 .apple-gradient-text.colorful-disabled,
  .dark h5 .apple-gradient-text.colorful-disabled,
  .dark h6 .apple-gradient-text.colorful-disabled,
  .dark span.apple-gradient-text.colorful-disabled {
    color: rgba(255, 255, 255, 0.95) !important; /* light text for dark mode */
  }

  /* Enhanced theme switch with proper sliding animation and icon transitions */
  #themeToggle:checked + div {
    background: linear-gradient(to right, rgb(59 130 246), rgb(79 70 229)) !important;
  }
  
  #themeToggle:checked + div > div {
    transform: translateX(1.5rem) !important;
  }
  
  #themeToggle:checked + div > div svg:first-child {
    opacity: 0 !important;
  }
  
  #themeToggle:checked + div > div svg:last-child {
    opacity: 1 !important;
  }
  
  #themeToggle:not(:checked) + div > div svg:first-child {
    opacity: 1 !important;
  }
  
  #themeToggle:not(:checked) + div > div svg:last-child {
    opacity: 0 !important;
  }
  
  /* Improved switch hover and focus states */
  .relative.inline-flex.items-center.cursor-pointer:hover div {
    transform: scale(1.02);
  }
  
  .relative.inline-flex.items-center.cursor-pointer:active div {
    transform: scale(0.98);
  }
</style>
